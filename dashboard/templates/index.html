{% extends "base.html" %}

{% block head %}
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        .progress {
            height: 25px;
            font-size: 0.9rem;
        }
        /* Flexbox layout to push footer down */
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
    </style>
{% endblock %}

{% block page_title %}
    <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="d-flex align-items-center">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="CodecShift Logo" style="height: 40px;" class="me-3">
            <h1 class="mb-0">CodecShift</h1>
        </div>
        <div class="btn-toolbar" role="toolbar">
            <!-- Theme Switcher Dropdown -->
            <div class="dropdown me-2">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="themeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <span id="theme-icon" class="mdi"></span> Theme
                </button>
                <ul class="dropdown-menu" aria-labelledby="themeDropdown">
                    <li><button class="dropdown-item d-flex align-items-center" data-theme-value="light"><span class="mdi mdi-weather-sunny me-2"></span> Light</button></li>
                    <li><button class="dropdown-item d-flex align-items-center" data-theme-value="dark"><span class="mdi mdi-weather-night me-2"></span> Dark</button></li>
                    <li><button class="dropdown-item d-flex align-items-center" data-theme-value="auto"><span class="mdi mdi-desktop-classic me-2"></span> System</button></li>
                </ul>
            </div>
            <div class="btn-group me-2" role="group">
                <button type="button" class="btn btn-outline-secondary" id="view-errors-btn" data-bs-toggle="modal" data-bs-target="#failuresModal">
                    View Errors <span class="badge" id="fail-count-badge"></span>
                </button>
                <button type="button" class="btn btn-outline-danger" id="clear-errors-btn" title="Clear All Errors">
                    &times;
                </button>
            </div>
            {% if auth_enabled and user_name %}
                <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary me-3">Logout</a>
                <span class="navbar-text">{{ greeting }}, <strong>{{ user_name }}</strong></span>
            {% endif %}
        </div>
    </div>
    <!-- The clock is now below the buttons -->
    <div id="clock-container" class="text-end" style="min-height: 1.5rem;"></div>
{% endblock %}

{% block content %}
        <ul class="nav nav-tabs mt-2" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="nodes-tab" data-bs-toggle="tab" data-bs-target="#nodes-tab-pane" type="button" role="tab">Active Nodes</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="jobs-tab" data-bs-toggle="tab" data-bs-target="#jobs-tab-pane" type="button" role="tab" aria-controls="jobs-tab-pane" aria-selected="false">Job Queue</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="history-stats-tab" data-bs-toggle="tab" data-bs-target="#history-stats-tab-pane" type="button" role="tab">History & Stats</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="cleanup-tab" data-bs-toggle="tab" data-bs-target="#cleanup-tab-pane" type="button" role="tab">Cleanup</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="options-tab" data-bs-toggle="tab" data-bs-target="#options-tab-pane" type="button" role="tab">Options</button>
            </li>
        </ul>

        <div class="tab-content" id="mainTabContent">
            <!-- Nodes Tab -->
            <div class="tab-pane fade" id="nodes-tab-pane" role="tabpanel">
                <div id="db-error-alert" class="alert alert-danger mt-3 {{ 'd-none' if not db_error }}">
                    <strong>Database Error:</strong> {{ db_error }}
                </div>
                <div id="nodes-container" class="mt-3">
                    {% if nodes %}
                        {% for node in nodes %}
                        <div class="card mb-3">
                            <div class="card-header fs-5 d-flex justify-content-between align-items-center">
                                <span>{{ node.hostname }}</span>
                                <span class="badge bg-info">{{ node.version }}</span>
                            </div>
                            <div class="card-body">
                                {% if node.percent > 0 %}
                                    <p class="card-text text-body-secondary mb-2" style="font-family: monospace;">{{ node.current_file }}</p>
                                    <div class="progress" role="progressbar">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated text-bg-{{ node.color }}" style="width: {{ node.percent }}%">
                                            <b>{{ node.percent }}%</b>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="text-center p-3">
                                        <h5 class="card-title text-muted">{{ node.current_file or 'Idle' }}</h5>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="card-footer text-end bg-transparent">
                                {% if node.percent > 0 %}
                                    <span class="badge text-bg-secondary me-2">FPS: {{ node.fps }}</span>
                                    <span class="badge text-bg-secondary me-2">Speed: {{ node.speed }}x</span>
                                    <span class="badge text-bg-{{ node.color }}">Codec: {{ node.codec }}</span>
                                {% else %}
                                    <span class="badge text-bg-secondary">Idle</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center p-5">
                            <p class="text-muted">No active nodes found.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            <!-- Job Queue Tab -->
            <div class="tab-pane fade" id="jobs-tab-pane" role="tabpanel" aria-labelledby="jobs-tab" tabindex="0">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Job Queue</h1>
                    <div>
                        <div class="btn-toolbar" role="toolbar" aria-label="Job queue actions">
                            <div class="btn-group me-2" role="group" aria-label="Scan controls">
                                <button class="btn btn-primary" id="manual-scan-btn" title="Trigger a manual scan of your Plex libraries"><span class="mdi mdi-sync"></span> Manual Scan</button>
                                <div class="input-group-text" title="Force the scanner to re-add files that are already in the queue or history">
                                    <input class="form-check-input mt-0" type="checkbox" id="force-rescan-checkbox">
                                    <label class="form-check-label ms-2" for="force-rescan-checkbox">Force</label>
                                </div>
                            </div>
                            <div class="btn-group me-2" role="group" aria-label="Main queue controls">
                                <button class="btn btn-warning" id="pause-queue-btn" title="Pause or resume the distribution of new jobs to workers"><span class="mdi mdi-pause"></span> Pause Queue</button>
                            </div>
                            <div class="btn-group" role="group" aria-label="Cleanup and clear controls">
                                <button class="btn btn-info" id="release-selected-btn" title="Release selected cleanup jobs to the queue"><span class="mdi mdi-lock-open-variant"></span> Release Selected</button>
                                <button class="btn btn-info" id="release-all-btn" title="Release all cleanup jobs awaiting approval"><span class="mdi mdi-lock-open-variant-outline"></span> Release All</button>
                                <button class="btn btn-danger" id="clear-jobs-btn" title="Permanently delete all pending jobs from the queue"><span class="mdi mdi-delete-sweep"></span> Clear Queue</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="scan-status" class="mb-3"></div>
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr><th><input type="checkbox" id="select-all-cleanup" title="Select all visible cleanup jobs"></th><th>File Path</th><th>Type</th><th>Status</th><th>Assigned To</th><th>Created</th></tr>
                        </thead>
                        <tbody id="job-queue-table-body"></tbody>
                    </table>
                </div>
                <!-- Pagination Controls for Job Queue -->
                <nav>
                    <ul class="pagination justify-content-center" id="job-queue-pagination">
                        <!-- Pagination links will be generated by JavaScript -->
                    </ul>
                </nav>
            </div>
            <!-- History & Stats Tab -->
            <div class="tab-pane fade" id="history-stats-tab-pane" role="tabpanel">
                <div class="mt-3">
                    <!-- Stat cards will be loaded here by JavaScript -->
                    <div class="row text-center g-3" id="stats-cards-container">
                        <div class="col-12">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                    <hr class="my-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="w-50">
                            <input type="text" id="history-search-input" class="form-control" placeholder="Search by filename or node...">
                        </div>
                        <button class="btn btn-danger" id="clear-history-btn">Clear All History</button>
                    </div>
                    <!-- Full History Table -->
                    <table class="table table-hover table-sm">
                        <thead>
                            <tr>
                                <th>ID</th> <!-- This was previously Job ID -->
                                <th>File</th>
                                <th>Node</th>
                                <th>Codec</th>
                                <th>Size (GB)</th>
                                <th>Reduction</th>
                                <th>Date</th>
                                <th></th> <!-- For delete button -->
                            </tr>
                        </thead>
                        <tbody id="history-table-body"></tbody>
                    </table>
                    <nav>
                        <ul class="pagination justify-content-center" id="history-pagination">
                            <!-- Pagination links will be generated by JavaScript -->
                        </ul>
                    </nav>
                </div>
            </div>
            <!-- Options Tab -->
            <div class="tab-pane fade" id="options-tab-pane" role="tabpanel">
                <div class="mt-3">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ category }} alert-dismissible fade show mt-3" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <form method="POST" action="/options" class="mt-4">
                        <!-- Plex Settings -->
                        <div class="p-3 border rounded mb-4">
                            <h5>Plex Integration</h5>
                            {% set plex_token = settings.get('plex_token', {}).get('setting_value') %}
                            <div class="row">
                                <!-- Left Column: Authentication -->
                                <div class="col-md-6 mb-3">
                                    <div class="mb-3">
                                        <label for="plex_url" class="form-label"><strong>Plex Server URL</strong></label>
                                        <input type="text" class="form-control" id="plex_url" name="plex_url" value="{{ settings.get('plex_url', {}).get('setting_value', '') }}" placeholder="http://192.168.1.100:32400">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label"><strong>Authentication</strong></label>
                                        <div>
                                            {% if plex_token %}
                                                <button type="button" class="btn btn-danger" id="plex-logout-btn">Unlink Plex Account</button>
                                                <div class="mt-2 text-success">✓ Account Linked</div>
                                            {% else %}
                                                <button type="button" class="btn btn-primary" id="plex-login-btn">Link Plex Account</button>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <!-- Right Column: Monitored Libraries -->
                                <div class="col-md-6 mb-3" id="plex-libraries-container" {% if not plex_token %}style="display: none;"{% endif %}>
                                    <label class="form-label"><strong>Monitored Libraries</strong></label>
                                    <div id="plex-libraries-list" class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                                        <!-- Checkboxes will be dynamically inserted here -->
                                    </div>
                                </div>
                            </div>
                            <!-- Path Mappings -->
                            <div class="p-3 border rounded mb-4">
                                <h5>Path Mappings</h5>
                                <p class="form-text text-body-secondary">Translate paths from what Plex sees to what the container sees. Useful if your media is on a NAS (e.g., `/nfs/media` -> `/media`).</p>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="plex_path_from" class="form-label"><strong>Path in Plex</strong></label>
                                        <input type="text" class="form-control" id="plex_path_from" name="plex_path_from" value="{{ settings.get('plex_path_from', {}).get('setting_value', '') }}" placeholder="/nfs/media/">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="plex_path_to" class="form-label"><strong>Path in Container</strong></label>
                                        <input type="text" class="form-control" id="plex_path_to" name="plex_path_to" value="{{ settings.get('plex_path_to', {}).get('setting_value', '') }}" placeholder="/media/">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Rescan Delay Setting -->
                        <div class="row">
                            <!-- Left Column -->
                            <div class="col-md-6">
                                <h5>File Handling</h5>
                                <div class="mb-3 p-3 border rounded">
                                    <label for="min_length" class="form-label"><strong>Minimum Video Length</strong></label>
                                    <p class="form-text text-body-secondary">Only transcode videos longer than this duration in minutes.</p>
                                    <input type="number" class="form-control" id="min_length" name="min_length" value="{{ settings.get('min_length', {}).get('setting_value', 0.5) }}" step="0.1">
                                </div>
                                <div class="mb-3 p-3 border rounded">
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" type="checkbox" role="switch" id="keep_original" name="keep_original" value="true" {{ 'checked' if settings.get('keep_original', {}).get('setting_value') == 'true' }}>
                                        <label class="form-check-label" for="keep_original"><strong>Keep Original File</strong></label>
                                    </div>
                                    <label for="backup_directory" class="form-label"><strong>Backup Directory</strong></label>
                                    <p class="form-text text-body-secondary">If specified, move original files here instead of deleting them. Requires "Keep Original" to be off.</p>
                                    <input type="text" class="form-control" id="backup_directory" name="backup_directory" value="{{ settings.get('backup_directory', {}).get('setting_value', '') }}" placeholder="/path/to/backups">
                                </div>
                            </div>
                            <!-- Right Column -->
                            <div class="col-md-6">
                                <h5>Transcoding &amp; System</h5>
                                <div class="mb-3 p-3 border rounded">
                                    <label for="rescan_delay_minutes" class="form-label"><strong>Automatic Rescan Delay</strong></label>
                                    <p class="form-text text-body-secondary">Time in minutes between automatic Plex library scans. Set to 0 to disable automatic scanning.</p>
                                    <input type="number" class="form-control" id="rescan_delay_minutes" name="rescan_delay_minutes" value="{{ settings.get('rescan_delay_minutes', {}).get('setting_value', '0') }}" min="0">
                                </div>
                                <div class="mb-3 p-3 border rounded">
                                    <label for="worker_poll_interval" class="form-label"><strong>Worker Poll Interval</strong></label>
                                    <p class="form-text text-body-secondary">Time in seconds a worker waits before asking for a new job when the queue is empty.</p>
                                    <input type="number" class="form-control" id="worker_poll_interval" name="worker_poll_interval" value="{{ settings.get('worker_poll_interval', {}).get('setting_value', '30') }}" min="5">
                                </div>
                                <div class="mb-3 p-3 border rounded">
                                    <label class="form-label"><strong>Hardware Acceleration</strong></label>
                                    <p class="form-text text-body-secondary">Force a specific hardware encoder. 'Auto' lets the worker decide.</p>
                                    {% set accel = settings.get('hardware_acceleration', {}).get('setting_value', 'auto') %}
                                    <div class="form-check"><input class="form-check-input" type="radio" name="hardware_acceleration" id="accel_auto" value="auto" {{ 'checked' if accel == 'auto' }}><label class="form-check-label" for="accel_auto">Auto</label></div>
                                    <div class="form-check"><input class="form-check-input" type="radio" name="hardware_acceleration" id="accel_nvidia" value="nvidia" {{ 'checked' if accel == 'nvidia' }}><label class="form-check-label" for="accel_nvidia">NVIDIA NVENC</label></div>
                                    <div class="form-check"><input class="form-check-input" type="radio" name="hardware_acceleration" id="accel_qsv" value="qsv" {{ 'checked' if accel == 'qsv' }}><label class="form-check-label" for="accel_qsv">Intel QSV</label></div>
                                    <div class="form-check"><input class="form-check-input" type="radio" name="hardware_acceleration" id="accel_vaapi" value="vaapi" {{ 'checked' if accel == 'vaapi' }}><label class="form-check-label" for="accel_vaapi">VA-API</label></div>
                                    <div class="form-check"><input class="form-check-input" type="radio" name="hardware_acceleration" id="accel_cpu" value="cpu" {{ 'checked' if accel == 'cpu' }}><label class="form-check-label" for="accel_cpu">CPU Only</label></div>
                                </div>
                                <div class="mb-3 p-3 border rounded">
                                    <label class="form-label"><strong>Allowed Codecs</strong></label>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" id="allow_hevc" name="allow_hevc" value="true" {{ 'checked' if settings.get('allow_hevc', {}).get('setting_value') == 'true' }}>
                                        <label class="form-check-label" for="allow_hevc">Allow HEVC (H.265)</label>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" id="allow_av1" name="allow_av1" value="true" {{ 'checked' if settings.get('allow_av1', {}).get('setting_value') == 'true' }}>
                                        <label class="form-check-label" for="allow_av1">Allow AV1</label>
                                    </div>
                                </div>
                                <div class="mb-3 p-3 border rounded">
                                    <label class="form-label"><strong>Maintenance</strong></label>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" id="auto_update" name="auto_update" value="true" {{ 'checked' if settings.get('auto_update', {}).get('setting_value') == 'true' }}>
                                        <label class="form-check-label" for="auto_update">Enable Worker Auto-Update</label>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" id="clean_failures" name="clean_failures" value="true" {{ 'checked' if settings.get('clean_failures', {}).get('setting_value') == 'true' }}>
                                        <label class="form-check-label" for="clean_failures">Clean Failed Jobs on Start</label>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" id="debug" name="debug" value="true" {{ 'checked' if settings.get('debug', {}).get('setting_value') == 'true' }}>
                                        <label class="form-check-label" for="debug">Enable Debug Logging</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr class="my-4">
                        <h5>Advanced Transcoding Settings</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3 p-3 border rounded">
                                    <label class="form-label"><strong>Constant Quality (CQ / CRF)</strong></label>
                                    <p class="form-text text-body-secondary">Lower is higher quality. NVENC: 0-51. VAAPI/CPU: 0-63.</p>
                                    <div class="input-group input-group-sm mb-2">
                                        <span class="input-group-text" style="width: 120px;">NVIDIA (HD)</span>
                                        <input type="number" class="form-control" name="nvenc_cq_hd" value="{{ settings.get('nvenc_cq_hd', {}).get('setting_value', 32) }}">
                                        <span class="input-group-text" style="width: 120px;">NVIDIA (SD)</span>
                                        <input type="number" class="form-control" name="nvenc_cq_sd" value="{{ settings.get('nvenc_cq_sd', {}).get('setting_value', 28) }}">
                                    </div>
                                    <div class="input-group input-group-sm mb-2">
                                        <span class="input-group-text" style="width: 120px;">Intel/AMD (HD)</span>
                                        <input type="number" class="form-control" name="vaapi_cq_hd" value="{{ settings.get('vaapi_cq_hd', {}).get('setting_value', 28) }}">
                                        <span class="input-group-text" style="width: 120px;">Intel/AMD (SD)</span>
                                        <input type="number" class="form-control" name="vaapi_cq_sd" value="{{ settings.get('vaapi_cq_sd', {}).get('setting_value', 24) }}">
                                    </div>
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text" style="width: 120px;">CPU (HD)</span>
                                        <input type="number" class="form-control" name="cpu_cq_hd" value="{{ settings.get('cpu_cq_hd', {}).get('setting_value', 28) }}">
                                        <span class="input-group-text" style="width: 120px;">CPU (SD)</span>
                                        <input type="number" class="form-control" name="cpu_cq_sd" value="{{ settings.get('cpu_cq_sd', {}).get('setting_value', 24) }}">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3 p-3 border rounded">
                                    <label for="cq_width_threshold" class="form-label"><strong>HD Width Threshold</strong></label>
                                    <p class="form-text text-body-secondary">Videos wider than this (in pixels) use the "HD" quality setting.</p>
                                    <input type="number" class="form-control" id="cq_width_threshold" name="cq_width_threshold" value="{{ settings.get('cq_width_threshold', {}).get('setting_value', 1900) }}">                                    
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Settings</button>
                    </form>
                </div>
            </div>
            <!-- Cleanup Tab -->
            <div class="tab-pane fade" id="cleanup-tab-pane" role="tabpanel">
                <div class="mt-3">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">System Cleanup</h1>
                    </div>
                    <p>This tool creates jobs for workers to clean up stale files left behind by crashed or improperly stopped workers.</p>
                    <p>This includes temporary encode files (<code>.tmp_*</code>) and file locks (<code>.lock</code>).</p>
                    <button class="btn btn-warning" id="create-cleanup-jobs-btn">Queue Stale File Cleanup</button>
                    <div id="cleanup-status" class="mt-3">
                        <!-- Status messages will appear here -->
                    </div>
                </div>
            </div>
        </div>
{% endblock %}

{% block scripts %}
    <!-- Failures Modal -->
    <div class="modal fade" id="failuresModal" tabindex="-1" aria-labelledby="failuresModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="failuresModalLabel">Failed Transcodes</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>File</th>
                                <th>Reason</th>
                                <th>Reported At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="failures-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Per-Node Options Modal -->
    <div class="modal fade" id="nodeOptionsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="nodeOptionsModalTitle">Node Options</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>More per-node options will be available here in the future.</p>
                    <button id="quit-node-btn" class="btn btn-danger w-100">Quit Worker Process</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Function to create an HTML element for a single node
        function createNodeCard(node) {
            const isIdle = node.status === 'idle' || node.percent === 0;
            return `
            <div class="card mb-3">
                <div id="node-${node.hostname}" class="card-header fs-5 d-flex justify-content-between align-items-center">
                    <span>
                        <span class="health-icon me-2" title="Calculating...">●</span>${node.hostname}
                    </span>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-2" onclick="showNodeOptions('${node.hostname}')">Options</button>
                        <button class="btn btn-sm btn-success" onclick="startNode('${node.hostname}')" ${node.status === 'running' || node.status === 'paused' ? 'disabled' : ''}>Start</button>
                        <button class="btn btn-sm btn-danger" onclick="stopNode('${node.hostname}')" ${node.status === 'idle' || node.status === 'finishing' ? 'disabled' : ''}>Stop</button>
                        <button class="btn btn-sm btn-warning" onclick="pauseResumeNode('${node.hostname}', '${node.status}')" ${node.status === 'idle' ? 'disabled' : ''}>${node.status === 'paused' ? 'Resume' : 'Pause'}</button>
                        <span class="badge bg-info">${node.version || 'N/A'}</span>
                    </div>
                </div>
                <div class="card-body">
                    ${node.percent > 0 ? `
                        <p class="card-text text-body-secondary mb-2" style="font-family: monospace;">${node.current_file || 'N/A'}</p>
                        <div class="progress" role="progressbar">
                            <div class="progress-bar progress-bar-striped progress-bar-animated text-bg-${node.color}" style="width: ${node.percent}%">
                                <b>${node.percent}%</b>
                            </div>
                        </div>
                    ` : `
                        <div class="text-center p-3">
                            <h5 class="card-title text-muted">${node.status === 'paused' ? 'Paused' : (node.status === 'finishing' ? 'Finishing...' : (node.current_file || 'Idle'))}</h5>
                        </div>
                    `}
                </div>
                <div class="card-footer text-end bg-transparent">
                    ${node.percent > 0 ? `
                        <span class="badge text-bg-secondary me-2">FPS: ${node.fps || 'N/A'}</span>
                        <span class="badge text-bg-secondary me-2">Speed: ${node.speed}x</span>
                        <span class="badge text-bg-${node.color}">Codec: ${node.codec}</span>
                    ` : `
                        <span class="badge text-bg-secondary">${node.status === 'paused' ? 'Paused' : (node.current_file || 'Idle')}</span>
                    `}
                </div>
            </div>`;
        }

        // Main function to fetch data and update the DOM
        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                // Update summary badges
                const failCount = data.fail_count;
                const failCountBadge = document.getElementById('fail-count-badge');
                const viewErrorsBtn = document.getElementById('view-errors-btn');
                failCountBadge.innerText = failCount;
                failCountBadge.classList.remove('text-bg-light', 'text-bg-dark'); // Reset badge color
                
                // Update clock
                const clockContainer = document.getElementById('clock-container');
                if (clockContainer) {
                    clockContainer.innerHTML = `<span class="badge text-bg-secondary fs-6">Updated: ${new Date().toLocaleTimeString()}</span>`;
                }
                
                // Update View Errors button color
                // Remove all potential color classes first
                viewErrorsBtn.classList.remove('btn-danger', 'btn-success', 'btn-warning');
                const clearErrorsBtn = document.getElementById('clear-errors-btn');
                clearErrorsBtn.style.display = (failCount > 0) ? 'inline-block' : 'none';

                // If there are errors, the button is always red.
                if (failCount > 0) {
                    viewErrorsBtn.classList.add('btn-danger');
                    failCountBadge.classList.add('text-bg-light');
                }
                
                // Update DB error alert
                const errorAlert = document.getElementById('db-error-alert');
                if (data.db_error) {
                    errorAlert.innerHTML = `<strong>Database Error:</strong> ${data.db_error}`;
                    errorAlert.classList.remove('d-none');
                } else {
                    errorAlert.classList.add('d-none');
                }

                // --- Update Pause Queue Button State ---
                const pauseQueueBtn = document.getElementById('pause-queue-btn');
                if (data.queue_paused) {
                    pauseQueueBtn.classList.remove('btn-warning');
                    pauseQueueBtn.classList.add('btn-success');
                    pauseQueueBtn.innerHTML = `<span class="mdi mdi-play"></span> Resume Queue`;
                    pauseQueueBtn.title = "Resume the distribution of new jobs to workers";
                } else {
                    pauseQueueBtn.classList.remove('btn-success');
                    pauseQueueBtn.classList.add('btn-warning');
                    pauseQueueBtn.innerHTML = `<span class="mdi mdi-pause"></span> Pause Queue`;
                    pauseQueueBtn.title = "Pause the distribution of new jobs to workers";
                }

                // Update nodes list
                const nodesContainer = document.getElementById('nodes-container');
                if (data.nodes && data.nodes.length > 0) {
                    nodesContainer.innerHTML = data.nodes.map(createNodeCard).join('');
                } else {
                    nodesContainer.innerHTML = `
                    <div class="text-center p-5">
                        <p class="text-muted">No active nodes found.</p>
                    </div>`;
                }

                // --- NEW: Update Health Icons ---
                data.nodes.forEach(node => {
                    const cardHeader = document.getElementById(`node-${node.hostname}`);
                    if (cardHeader) {
                        const healthIcon = cardHeader.querySelector('.health-icon');
                        if (node.age < 30) {
                            healthIcon.style.color = 'green';
                            healthIcon.title = `Healthy (last seen ${Math.round(node.age)}s ago)`;
                        } else if (node.age < 60) {
                            healthIcon.style.color = 'orange';
                            healthIcon.title = `Warning (last seen ${Math.round(node.age)}s ago)`;
                        } else {
                            healthIcon.style.color = 'red';
                            healthIcon.title = `Critical (last seen ${Math.round(node.age)}s ago)`;
                        }
                    }
                });
            } catch (error) {
                console.error("Failed to fetch status:", error);
                const errorAlert = document.getElementById('db-error-alert');
                errorAlert.innerHTML = `<strong>Frontend Error:</strong> Could not fetch status from the server.`;
                errorAlert.classList.remove('d-none');
            }
        }

        // Function to fetch and display failures in the modal
        document.getElementById('view-errors-btn').addEventListener('click', async () => {
            const tableBody = document.getElementById('failures-table-body');
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center">Loading...</td></tr>';
            try {
                const response = await fetch('/api/failures');
                const data = await response.json();
                if (data.files && data.files.length > 0) {
                    tableBody.innerHTML = data.files.map((file, index) => `
                        <tr>
                            <td style="word-break: break-all;">${file.filename}</td>
                            <td>${file.reason}</td>
                            <td>${file.reported_at}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-log-${index}">
                                    View Log
                                </button>
                            </td>
                        </tr>
                        <tr class="collapse" id="collapse-log-${index}">
                            <td colspan="4"><pre class="bg-dark text-white-50 p-3 rounded" style="max-height: 300px; overflow-y: auto;">${file.log || 'No log available.'}</pre></td>
                        </tr>
                    `).join('');
                } else {
                    tableBody.innerHTML = '<tr><td colspan="3" class="text-center">No failed files found.</td></tr>';
                }
            } catch (error) {
                tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-danger">Failed to load errors.</td></tr>';
            }
        });

        // Function to clear all failures
        document.getElementById('clear-errors-btn').addEventListener('click', async () => {
            if (!confirm('Are you sure you want to permanently clear all failed file logs? This action cannot be undone.')) {
                return;
            }
            try {
                const response = await fetch('/api/failures/clear', { method: 'POST' });
                if (response.ok) {
                    // Manually close the modal if it's open
                    const modal = bootstrap.Modal.getInstance(document.getElementById('failuresModal'));
                    if (modal) modal.hide();
                    // Refresh the status to update the count
                    updateStatus();
                }
            } catch (error) {
                alert('An error occurred while trying to clear the failures.');
            }
        });

        // Main update loop that runs every 5 seconds
        async function mainUpdateLoop() {
            // Always update the main status (nodes, failures, clock)
            await updateStatus();

            // Check which tab is active and update its content if needed
            if (document.querySelector('#history-stats-tab.active')) {
                await updateHistoryAndStats();
            }

            // Update job queue if its tab is active
            if (document.querySelector('#jobs-tab.active')) {
                await updateJobQueue(jobQueueCurrentPage); // Use the current page for refresh
            }
        }

        // Run initial update on page load
        updateStatus();

        // Function to clear all history
        document.getElementById('clear-history-btn').addEventListener('click', async () => {
            if (!confirm('Are you sure you want to permanently clear the entire transcode history? This action cannot be undone.')) {
                return;
            }
            try {
                const response = await fetch('/api/history/clear', { method: 'POST' });
                if (response.ok) {
                    // Refresh the history table to show it's empty
                    updateHistoryAndStats();
                }
            } catch (error) {
                console.error('Error clearing history:', error);
                alert('An error occurred while trying to clear the history.');
            }
        });

        // Function to update the job queue
        let jobQueueCurrentPage = 1; // Keep track of the current page
        async function updateJobQueue(page = 1) {
            jobQueueCurrentPage = page;
            try {
                const response = await fetch(`/api/jobs?page=${page}`);
                const data = await response.json();
                const tableBody = document.getElementById('job-queue-table-body');
                tableBody.innerHTML = ''; // Clear existing rows

                if (data.db_error) {
                    tableBody.innerHTML = `<tr><td colspan="6" class="text-danger">Database Error: ${data.db_error}</td></tr>`;
                    return;
                }

                if (data.jobs.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No jobs in the queue.</td></tr>';
                    return;
                }

                // Build the entire table HTML at once and set it. This is much more efficient
                // and prevents the "ghost row" rendering bug.
                const rowsHtml = data.jobs.map(job => `
                    <tr>
                        <td>
                            ${job.job_type === 'cleanup' && job.status === 'awaiting_approval' ? 
                                `<input type="checkbox" class="form-check-input cleanup-checkbox" data-job-id="${job.id}">` : 
                                job.id 
                            }
                        </td>
                        <td style="word-break: break-all;">${job.filepath}</td>
                        <td><span class="badge bg-info text-dark">${job.job_type}</span></td>
                        <td>
                            ${job.status === 'encoding' ? 
                                `<span class="badge text-bg-primary"><span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Encoding</span>` :
                            job.status === 'awaiting_approval' ?
                                `<span class="badge text-bg-warning">Awaiting Approval</span>` :
                            job.status === 'pending' ?
                                `<span class="badge text-bg-secondary">Pending</span>` :
                            job.status === 'failed' ?
                                `<span class="badge text-bg-danger">Failed</span>` :
                                `<span class="badge text-bg-warning">${job.status}</span>`
                            }
                        </td>
                        <td>${job.assigned_to || 'N/A'}</td>
                        <td>${new Date(job.created_at).toLocaleString()}</td>
                    </tr>
                `).join('');
                tableBody.innerHTML = rowsHtml;

                renderJobQueuePagination(data.page, Math.ceil(data.total_jobs / data.per_page));

                // Add event listener for the new "select all" checkbox
                const selectAllCheckbox = document.getElementById('select-all-cleanup');
                selectAllCheckbox.addEventListener('change', (e) => {
                    document.querySelectorAll('.cleanup-checkbox').forEach(checkbox => {
                        checkbox.checked = e.target.checked;
                    });
                });
                // Uncheck "select all" if any individual box is unchecked
                document.querySelectorAll('.cleanup-checkbox').forEach(checkbox => checkbox.addEventListener('change', () => { if (!checkbox.checked) selectAllCheckbox.checked = false; }));

            } catch (error) {
                console.error('Error fetching job queue:', error);
                document.getElementById('job-queue-table-body').innerHTML = `<tr><td colspan="6" class="text-danger">Failed to fetch job queue.</td></tr>`;
            }
        }

        // Function to create cleanup jobs
        document.getElementById('create-cleanup-jobs-btn').addEventListener('click', async () => {
            const statusDiv = document.getElementById('cleanup-status');
            statusDiv.innerHTML = `<div class="spinner-border spinner-border-sm" role="status"></div> Searching for stale files...`;
            const response = await fetch('/api/jobs/create_cleanup', { method: 'POST' });
            if (!response.ok) {
                statusDiv.innerHTML = `<div class="alert alert-danger" role="alert">Error communicating with server.</div>`;
                return;
            }
            const result = await response.json();
            const alertClass = result.success ? 'alert-success' : 'alert-danger';
            statusDiv.innerHTML = `<div class="alert ${alertClass}" role="alert">${result.message || result.error}</div>`;
        });

        // --- History & Stats Page Logic ---
        let fullHistoryData = [];
        let historyCurrentPage = 1;
        const historyItemsPerPage = 15;

        // Combined function to fetch and display stats and history
        async function updateHistoryAndStats() {
            const statsCardsContainer = document.getElementById('stats-cards-container');
            const historyBody = document.getElementById('history-table-body');

            try {
                // Fetch both stats and history in parallel
                const [statsResponse, historyResponse] = await Promise.all([
                    fetch('/api/stats'),
                    fetch('/api/history')
                ]);

                // Process Stats
                const statsData = await statsResponse.json();
                const reductionPercent = parseFloat(statsData.stats.total_reduction_percent);
                let reductionColorClass = 'bg-success';
                if (reductionPercent < 50) {
                    reductionColorClass = 'bg-danger';
                } else if (reductionPercent < 75) {
                    reductionColorClass = 'bg-warning text-dark'; // Add text-dark for better contrast on yellow
                }

                statsCardsContainer.innerHTML = `
                    <div class="col-md-3"><div class="card"><div class="card-body">
                        <h5 class="card-title">${statsData.stats.total_files}</h5><p class="card-text text-muted">Files Encoded</p>
                    </div></div></div>
                    <div class="col-md-3"><div class="card"><div class="card-body">
                        <h5 class="card-title">${statsData.stats.total_new_size_gb} GB</h5><p class="card-text text-muted">New Size</p>
                    </div></div></div>
                    <div class="col-md-3"><div class="card"><div class="card-body">
                        <h5 class="card-title">${statsData.stats.total_original_size_gb} GB</h5><p class="card-text text-muted">Original Size</p>
                    </div></div></div>
                    <div class="col-md-3"><div class="card ${reductionColorClass}"><div class="card-body">
                        <h5 class="card-title">${statsData.stats.total_reduction_percent}%</h5><p class="card-text">Average Reduction</p>
                    </div></div></div>
                `;

                // Process History
                const historyData = await historyResponse.json();
                fullHistoryData = historyData.history || [];
                renderHistoryTable(); // Render the table with the new data

            } catch (error) {
                console.error("Failed to fetch history/stats:", error);
                statsCardsContainer.innerHTML = '<div class="col-12"><div class="alert alert-danger">Failed to load statistics.</div></div>';
                historyBody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Failed to load history.</td></tr>';
            }
        }

        // Function to render the history table with search and pagination
        function renderHistoryTable() {
            const historyBody = document.getElementById('history-table-body');
            const paginationContainer = document.getElementById('history-pagination');
            const searchTerm = document.getElementById('history-search-input').value.toLowerCase();

            const filteredData = fullHistoryData.filter(item => 
                item.filename.toLowerCase().includes(searchTerm) ||
                item.hostname.toLowerCase().includes(searchTerm)
            );

            const totalPages = Math.ceil(filteredData.length / historyItemsPerPage);
            if (historyCurrentPage > totalPages) {
                historyCurrentPage = totalPages || 1;
            }
            const startIndex = (historyCurrentPage - 1) * historyItemsPerPage;
            const paginatedData = filteredData.slice(startIndex, startIndex + historyItemsPerPage);

            // Render table rows
            if (paginatedData.length > 0) {
                historyBody.innerHTML = paginatedData.map(item => `
                    <tr>
                        <td>${item.id}</td>
                        <td style="word-break: break-all;">${item.filename}</td>
                        <td>${item.hostname}</td>
                        <td><span class="badge text-bg-secondary">${item.codec}</span></td>
                        ${item.status === 'encoding' ? `
                            <td colspan="2" class="text-center"><span class="badge text-bg-primary">In Progress</span></td>
                        ` : `
                            <td>${item.original_size_gb} → ${item.new_size_gb}</td>
                            <td><span class="badge text-bg-success">${item.reduction_percent}%</span></td>
                        `}
                        <td>${item.encoded_at}</td>
                        <td><button class="btn btn-xs btn-outline-danger" title="Delete this entry">&times;</button></td>
                    </tr>
                `).join('');
            } else {
                historyBody.innerHTML = `<tr><td colspan="7" class="text-center">${searchTerm ? 'No matching files found.' : 'No encoded files found.'}</td></tr>`;
            }

            // Render pagination
            paginationContainer.innerHTML = '';
            if (totalPages > 1) {
                for (let i = 1; i <= totalPages; i++) {
                    const li = document.createElement('li');
                    li.className = `page-item ${i === historyCurrentPage ? 'active' : ''}`;
                    li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                    li.addEventListener('click', (e) => {
                        e.preventDefault();
                        historyCurrentPage = i;
                        renderHistoryTable();
                    });
                    paginationContainer.appendChild(li);
                }
            }
        }

        // Event listener for the search input
        document.getElementById('history-search-input').addEventListener('input', () => {
            historyCurrentPage = 1; // Reset to first page on search
            renderHistoryTable();
        });

        // --- NEW: Smart Pagination Renderer ---
        function renderJobQueuePagination(currentPage, totalPages) {
            const paginationContainer = document.getElementById('job-queue-pagination');
            paginationContainer.innerHTML = '';
            if (totalPages <= 1) return;

            const pageWindow = 5; // How many pages to show around the current page

            // Helper to create a page link
            const createPageLink = (page, text, isDisabled = false, isActive = false) => {
                const li = document.createElement('li');
                li.className = `page-item ${isDisabled ? 'disabled' : ''} ${isActive ? 'active' : ''}`;
                const a = document.createElement('a');
                a.className = 'page-link';
                a.href = '#';
                a.innerText = text;
                if (!isDisabled) {
                    a.addEventListener('click', (e) => {
                        e.preventDefault();
                        updateJobQueue(page);
                    });
                }
                li.appendChild(a);
                return li;
            };

            // Previous Button
            paginationContainer.appendChild(createPageLink(currentPage - 1, 'Previous', currentPage === 1));

            // Page numbers
            let startPage = Math.max(1, currentPage - pageWindow);
            let endPage = Math.min(totalPages, currentPage + pageWindow);

            if (startPage > 1) {
                paginationContainer.appendChild(createPageLink(1, '1'));
                if (startPage > 2) {
                    paginationContainer.appendChild(createPageLink(0, '...', true));
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationContainer.appendChild(createPageLink(i, i.toString(), false, i === currentPage));
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationContainer.appendChild(createPageLink(0, '...', true));
                }
                paginationContainer.appendChild(createPageLink(totalPages, totalPages.toString()));
            }

            // Next Button
            paginationContainer.appendChild(createPageLink(currentPage + 1, 'Next', currentPage === totalPages));
        }

        // Update history/stats when the tab is shown
        const historyStatsTab = document.querySelector('#history-stats-tab');
        historyStatsTab.addEventListener('shown.bs.tab', () => {
            updateHistoryAndStats();
        });

        // Update job queue when its tab is shown
        const jobsTab = document.querySelector('#jobs-tab');
        jobsTab.addEventListener('shown.bs.tab', () => {
            updateJobQueue();
        });

        // Start the main update loop
        setInterval(mainUpdateLoop, 5000);
    </script>
    <script>
        // Function to send the 'start' command to a node
        async function startNode(hostname) {
            try {
                const response = await fetch(`/api/nodes/${hostname}/start`, {
                    method: 'POST',
                });
                const result = await response.json();

                if (result.success) {
                    // The command was successful, just refresh the UI.
                    // Immediately refresh the status to show the node has started
                    updateStatus();
                } else {
                    // If the server reported an error, show it.
                    alert(`Failed to send start command to ${hostname}: ${result.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error starting node:', error);
                alert(`An error occurred while trying to start ${hostname}.`);
            }
        }

        // Function to send the 'stop' command to a node
        async function stopNode(hostname) {
            if (!confirm(`Are you sure you want to stop the worker on '${hostname}'? It will finish its current file and then go idle.`)) {
                return;
            }
            try {
                const response = await fetch(`/api/nodes/${hostname}/stop`, {
                    method: 'POST',
                });
                const result = await response.json();
                if (result.success) {
                    updateStatus(); // Refresh UI to show the node going idle
                } else {
                    alert(`Failed to send stop command to ${hostname}: ${result.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error stopping node:', error);
            }
        }

        // Function to send 'pause' or 'resume' command
        async function pauseResumeNode(hostname, currentStatus) {
            const action = currentStatus === 'paused' ? 'resume' : 'pause';
            try {
                const response = await fetch(`/api/nodes/${hostname}/${action}`, {
                    method: 'POST',
                });
                const result = await response.json();
                if (result.success) {
                    updateStatus(); // Refresh UI
                } else {
                    alert(`Failed to ${action} node ${hostname}: ${result.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error(`Error ${action}ing node:`, error);
            }
        }

        // Placeholder for future per-node options
        let nodeOptionsModal = null;
        function showNodeOptions(hostname) {
            if (!nodeOptionsModal) {
                nodeOptionsModal = new bootstrap.Modal(document.getElementById('nodeOptionsModal'));
            }
            document.getElementById('nodeOptionsModalTitle').innerText = `Options for ${hostname}`;
            const quitBtn = document.getElementById('quit-node-btn');
            // Re-assign the onclick event to the button for the specific hostname
            quitBtn.onclick = () => quitNode(hostname);
            nodeOptionsModal.show();
        }
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Function to send the 'quit' command to a node
            window.quitNode = async function(hostname) {
                if (!confirm(`Are you sure you want to QUIT the worker on '${hostname}'? This will stop the process immediately. The container will likely restart based on Docker policy.`)) {
                    return;
                }
                try {
                    const response = await fetch(`/api/nodes/${hostname}/quit`, {
                        method: 'POST',
                    });
                    const result = await response.json();
                    if (result.success) {
                        updateStatus(); // Refresh UI to show the node disappearing
                    } else {
                        alert(`Failed to send quit command to ${hostname}: ${result.error || 'Unknown error'}`);
                    }
                } catch (error) {
                    console.error('Error quitting node:', error);
                }
            }

            // Slider logic
            const delaySlider = document.getElementById('rescan_delay_minutes');
            if (delaySlider) {
                const delayValue = document.getElementById('delay-value');
                delaySlider.addEventListener('input', (event) => {
                    delayValue.textContent = `${event.target.value} min`;
                });
            }

            // Function to activate a tab based on URL hash
            function activateTabFromHash() {
                const hash = window.location.hash;
                if (hash) {
                    const triggerEl = document.querySelector(`button[data-bs-target="${hash}"]`);
                    if (triggerEl) {
                        const tab = new bootstrap.Tab(triggerEl);
                        tab.show();
                    }
                } else {
                    const defaultTab = document.getElementById('nodes-tab');
                    if (defaultTab) {
                        const tab = new bootstrap.Tab(defaultTab);
                        tab.show();
                    }
                }
            }
            activateTabFromHash();

            // --- Plex Authentication Logic ---
            const plexLoginBtn = document.getElementById('plex-login-btn');
            const plexLogoutBtn = document.getElementById('plex-logout-btn');
            const plexSignInBtn = document.getElementById('plex-signin-btn');

            if (plexLoginBtn) {
                plexLoginBtn.addEventListener('click', () => {
                    const loginModal = new bootstrap.Modal(document.getElementById('plexLoginModal'));
                    loginModal.show();
                });
            }

            if (plexSignInBtn) {
                plexSignInBtn.addEventListener('click', async () => {
                    const usernameInput = document.getElementById('plex-username');
                    const passwordInput = document.getElementById('plex-password');
                    const statusDiv = document.getElementById('plex-login-status');
                    statusDiv.innerHTML = `<div class="spinner-border spinner-border-sm"></div> Signing in...`;

                    const response = await fetch('/api/plex/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            username: usernameInput.value, 
                            password: passwordInput.value 
                        })
                    });
                    const data = await response.json();
                    if (data.success) {
                        statusDiv.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
                        setTimeout(() => window.location.href = '/#options-tab-pane', 1500);
                    } else {
                        statusDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                    }
                });
            }

            if (plexLogoutBtn) {
                plexLogoutBtn.addEventListener('click', async () => {
                    if (confirm('Are you sure you want to unlink your Plex account?')) {
                        await fetch('/api/plex/logout', { method: 'POST' });
                        window.location.reload();
                    }
                });
            }

            // --- Dynamic Plex Library Loading ---
            async function loadPlexLibraries() {
                const container = document.getElementById('plex-libraries-list');
                // Use the settings rendered directly into the page by the server.
                // This completely avoids any race conditions with the DOM.
                const hasToken = "{{ settings.get('plex_token', {}).get('setting_value') }}" !== "";

                if (!hasToken) {
                    container.innerHTML = `<p class="text-muted">Enter your Plex Server URL and link your account to see libraries.</p>`;
                    return;
                }

                const response = await fetch('/api/plex/libraries');
                const data = await response.json();
                const currentLibs = "{{ settings.get('plex_libraries', {}).get('setting_value', '') }}".split(',');

                if (data.libraries && data.libraries.length > 0) {
                    container.innerHTML = data.libraries.map(lib => `
                        <div class="form-check"><input class="form-check-input" type="checkbox" name="plex_libraries" value="${lib.title}" id="lib-${lib.key}" ${currentLibs.includes(lib.title) ? 'checked' : ''}><label class="form-check-label" for="lib-${lib.key}">${lib.title}</label></div>
                    `).join('');
                } else {
                    container.innerHTML = `<p class="text-muted">${data.error || 'No video libraries found.'}</p>`;
                }
            }
            if (document.getElementById('plex-libraries-container').style.display !== 'none') {
                loadPlexLibraries();
            }

            // --- Manual Plex Scan Logic ---
            const manualScanBtn = document.getElementById('manual-scan-btn');
            const scanStatusDiv = document.getElementById('scan-status');
            const forceRescanCheckbox = document.getElementById('force-rescan-checkbox');

            manualScanBtn.addEventListener('click', async () => {
                manualScanBtn.disabled = true;
                manualScanBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Scanning...`;
                scanStatusDiv.innerHTML = '';
                const isForced = forceRescanCheckbox.checked;

                try {
                    const response = await fetch('/api/plex/scan', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ force: isForced }) });
                    const data = await response.json();
                    const alertClass = data.success ? 'alert-success' : 'alert-warning';
                    scanStatusDiv.innerHTML = `<div class="alert ${alertClass} alert-dismissible fade show" role="alert">${data.message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
                    // Refresh the job queue to show any newly added jobs
                    updateJobQueue();
                } catch (error) {
                    scanStatusDiv.innerHTML = `<div class="alert alert-danger alert-dismissible fade show" role="alert">Error communicating with the server.<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
                } finally {
                    manualScanBtn.disabled = false;
                    manualScanBtn.innerHTML = `<span class="mdi mdi-sync"></span> Manual Scan`;
                }
            });

            // --- Release Cleanup Jobs Logic ---
            const releaseSelectedBtn = document.getElementById('release-selected-btn');
            const releaseAllBtn = document.getElementById('release-all-btn');

            releaseSelectedBtn.addEventListener('click', async () => {
                const selectedIds = Array.from(document.querySelectorAll('.cleanup-checkbox:checked')).map(cb => cb.dataset.jobId);
                if (selectedIds.length === 0) {
                    alert('No cleanup jobs selected.');
                    return;
                }
                if (confirm(`Are you sure you want to release ${selectedIds.length} cleanup job(s) to the queue?`)) {
                    await releaseJobs({ job_ids: selectedIds });
                }
            });

            releaseAllBtn.addEventListener('click', async () => {
                if (confirm('Are you sure you want to release ALL cleanup jobs that are awaiting approval?')) {
                    await releaseJobs({ release_all: true });
                }
            });

            async function releaseJobs(payload) {
                try {
                    const response = await fetch('/api/jobs/release', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) {
                        updateJobQueue(jobQueueCurrentPage); // Refresh the queue
                    }
                } catch (error) {
                    alert('An error occurred while trying to release cleanup jobs.');
                }
            }

            // --- Clear All Jobs Logic ---
            const clearJobsBtn = document.getElementById('clear-jobs-btn');
            clearJobsBtn.addEventListener('click', async () => {
                if (!confirm('Are you sure you want to permanently clear the entire job queue? This action cannot be undone.')) {
                    return;
                }
                try {
                    const response = await fetch('/api/jobs/clear', { method: 'POST' });
                    if (response.ok) {
                        updateJobQueue(1); // Refresh the queue to show it's empty
                    }
                } catch (error) {
                    alert('An error occurred while trying to clear the job queue.');
                }
            });

            // --- Pause Queue Button Logic ---
            const pauseQueueBtn = document.getElementById('pause-queue-btn');
            pauseQueueBtn.addEventListener('click', async () => {
                try {
                    const response = await fetch('/api/queue/toggle_pause', { method: 'POST' });
                    if (response.ok) {
                        mainUpdateLoop(); // Immediately refresh the UI to show the new state
                    }
                } catch (error) {
                    alert('An error occurred while trying to toggle the queue state.');
                }
            });
        });
    </script>
    <script>
        // --- Theme Switcher Logic ---
        (function() {
            const themeIcon = document.getElementById('theme-icon');
            const getStoredTheme = () => localStorage.getItem('theme');
            const setStoredTheme = theme => localStorage.setItem('theme', theme);

            const setTheme = theme => {
                document.documentElement.setAttribute('data-bs-theme', theme);
                // Update icon based on theme
                if (theme === 'dark') themeIcon.className = 'mdi mdi-weather-night';
                else if (theme === 'light') themeIcon.className = 'mdi mdi-weather-sunny';
                else themeIcon.className = 'mdi mdi-desktop-classic';
            };

            setTheme(getStoredTheme() || 'dark'); // Set initial theme

            document.querySelectorAll('[data-theme-value]').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const theme = toggle.getAttribute('data-theme-value');
                    setStoredTheme(theme);
                    setTheme(theme);
                });
            });
        })();
    </script>
    <!-- Plex Login Modal -->
    <div class="modal fade" id="plexLoginModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Link Your Plex Account</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">Enter your Plex.tv username and password to link your account. Your credentials are used once to get an authentication token and are never stored.</p>
                    <form id="plex-login-form">
                        <div class="mb-3">
                            <label for="plex-username" class="form-label">Plex Username</label>
                            <input type="text" class="form-control" id="plex-username" name="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="plex-password" class="form-label">Plex Password</label>
                            <input type="password" class="form-control" id="plex-password" name="password" required>
                        </div>
                        <button id="plex-signin-btn" type="button" class="btn btn-primary w-100">Sign In</button>
                    </form>
                    <div id="plex-login-status" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
