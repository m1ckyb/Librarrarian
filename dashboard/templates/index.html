<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transcode Cluster Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .progress {
            height: 25px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1>Transcode Cluster</h1>
            <div>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-danger" id="view-errors-btn" data-bs-toggle="modal" data-bs-target="#failuresModal">
                        View Errors <span class="badge text-bg-light" id="fail-count-badge">{{ fail_count }}</span>
                    </button>
                    <button type="button" class="btn btn-outline-danger" id="clear-errors-btn" title="Clear All Errors">
                        &times;
                    </button>
                </div>

                <span class="badge text-bg-secondary fs-6">
                    Updated: <span id="last-updated">{{ last_updated }}</span>
                </span>
            </div>
        </div>

        <div id="db-error-alert" class="alert alert-danger {{ 'd-none' if not db_error }}">
            <strong>Database Error:</strong> {{ db_error }}
        </div>

        <div id="nodes-container">
            {% if nodes %}
                {% for node in nodes %}
                <div class="card text-bg-dark mb-3">
                    <div class="card-header fs-5">{{ node.hostname }}</div>
                    <div class="card-body">
                        <p class="card-text text-white-50 mb-2" style="font-family: monospace;">{{ node.file }}</p>
                        <div class="progress" role="progressbar">
                            <div class="progress-bar progress-bar-striped progress-bar-animated text-bg-{{ node.color }}" style="width: {{ node.percent }}%">
                                <b>{{ node.percent }}%</b>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer text-end">
                        <span class="badge text-bg-light me-2">Speed: {{ node.speed }}x</span>
                        <span class="badge text-bg-{{ node.color }}">Codec: {{ node.codec }}</span>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="text-center p-5">
                    <p class="text-muted">No active nodes found.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Failures Modal -->
    <div class="modal fade" id="failuresModal" tabindex="-1" aria-labelledby="failuresModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="failuresModalLabel">Failed Transcodes</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th scope="col">File</th>
                                <th scope="col">Reason</th>
                                <th scope="col">Reported At</th>
                            </tr>
                        </thead>
                        <tbody id="failures-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Function to create an HTML element for a single node
        function createNodeCard(node) {
            return `
            <div class="card text-bg-dark mb-3">
                <div class="card-header fs-5">${node.hostname}</div>
                <div class="card-body">
                    <p class="card-text text-white-50 mb-2" style="font-family: monospace;">${node.file || 'N/A'}</p>
                    <div class="progress" role="progressbar">
                        <div class="progress-bar progress-bar-striped progress-bar-animated text-bg-${node.color}" style="width: ${node.percent}%">
                            <b>${node.percent}%</b>
                        </div>
                    </div>
                </div>
                <div class="card-footer text-end">
                    <span class="badge text-bg-light me-2">Speed: ${node.speed}x</span>
                    <span class="badge text-bg-${node.color}">Codec: ${node.codec}</span>
                </div>
            </div>`;
        }

        // Main function to fetch data and update the DOM
        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                // Update summary badges
                document.getElementById('fail-count-badge').innerText = data.fail_count;
                document.getElementById('last-updated').innerText = data.last_updated;

                // Update DB error alert
                const errorAlert = document.getElementById('db-error-alert');
                if (data.db_error) {
                    errorAlert.innerHTML = `<strong>Database Error:</strong> ${data.db_error}`;
                    errorAlert.classList.remove('d-none');
                } else {
                    errorAlert.classList.add('d-none');
                }

                // Update nodes list
                const nodesContainer = document.getElementById('nodes-container');
                if (data.nodes && data.nodes.length > 0) {
                    nodesContainer.innerHTML = data.nodes.map(createNodeCard).join('');
                } else {
                    nodesContainer.innerHTML = `
                    <div class="text-center p-5">
                        <p class="text-muted">No active nodes found.</p>
                    </div>`;
                }

            } catch (error) {
                console.error("Failed to fetch status:", error);
                const errorAlert = document.getElementById('db-error-alert');
                errorAlert.innerHTML = `<strong>Frontend Error:</strong> Could not fetch status from the server.`;
                errorAlert.classList.remove('d-none');
            }
        }

        // Function to fetch and display failures in the modal
        document.getElementById('view-errors-btn').addEventListener('click', async () => {
            const tableBody = document.getElementById('failures-table-body');
            tableBody.innerHTML = '<tr><td colspan="3" class="text-center">Loading...</td></tr>';
            try {
                const response = await fetch('/api/failures');
                const data = await response.json();
                if (data.files && data.files.length > 0) {
                    tableBody.innerHTML = data.files.map(file => `
                        <tr>
                            <td style="word-break: break-all;">${file.filename}</td>
                            <td>${file.reason}</td>
                            <td>${file.reported_at}</td>
                        </tr>
                    `).join('');
                } else {
                    tableBody.innerHTML = '<tr><td colspan="3" class="text-center">No failed files found.</td></tr>';
                }
            } catch (error) {
                tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-danger">Failed to load errors.</td></tr>';
            }
        });

        // Function to clear all failures
        document.getElementById('clear-errors-btn').addEventListener('click', async () => {
            if (!confirm('Are you sure you want to permanently clear all failed file logs? This action cannot be undone.')) {
                return;
            }
            try {
                const response = await fetch('/api/failures/clear', { method: 'POST' });
                if (response.ok) {
                    // Manually close the modal if it's open
                    const modal = bootstrap.Modal.getInstance(document.getElementById('failuresModal'));
                    if (modal) modal.hide();
                    // Refresh the status to update the count
                    updateStatus();
                }
            } catch (error) {
                alert('An error occurred while trying to clear the failures.');
            }
        });

        // Run the update function every 5 seconds (5000 milliseconds)
        setInterval(updateStatus, 5000);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
