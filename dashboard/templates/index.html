{% extends "base.html" %}

{% block head %}
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        .progress {
            height: 25px;
            font-size: 0.9rem;
        }
        /* Flexbox layout to push footer down */
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        /* Dev Mode Banner */
        .dev-mode-banner {
            position: fixed;
            top: 25px;
            left: -50px;
            background-color: #ffc107; /* Bootstrap 'warning' yellow */
            color: #000;
            padding: 5px 50px;
            transform: rotate(-45deg);
            font-weight: bold;
            font-size: 0.8rem;
            text-align: center;
            z-index: 1056; /* Higher than modals */
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border: 1px solid rgba(0,0,0,0.2);
        }
    </style>
{% endblock %}

{% block page_title %}
    {% if devmode %}
        <div class="dev-mode-banner">DEV MODE</div>
    {% endif %}
    <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="d-flex align-items-center">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="CodecShift Logo" style="height: 40px;" class="me-3">
        </div>
        <div class="btn-toolbar" role="toolbar">
            <!-- Theme Switcher Dropdown -->
            <div class="dropdown me-2">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="themeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <span id="theme-icon" class="mdi"></span> Theme
                </button>
                <ul class="dropdown-menu" aria-labelledby="themeDropdown">
                    <li><button class="dropdown-item d-flex align-items-center" data-theme-value="light"><span class="mdi mdi-weather-sunny me-2"></span> Light</button></li>
                    <li><button class="dropdown-item d-flex align-items-center" data-theme-value="dark"><span class="mdi mdi-weather-night me-2"></span> Dark</button></li>
                    <li><button class="dropdown-item d-flex align-items-center" data-theme-value="auto"><span class="mdi mdi-desktop-classic me-2"></span> System</button></li>
                </ul>
            </div>
            <div class="btn-group me-2" role="group">
                <button type="button" class="btn btn-outline-secondary" id="view-errors-btn" data-bs-toggle="modal" data-bs-target="#failuresModal">
                    View Errors <span class="badge" id="fail-count-badge"></span>
                </button>
                <button type="button" class="btn btn-outline-danger" id="clear-errors-btn" title="Clear All Errors">
                    &times;
                </button>
            </div>
            {% if auth_enabled and user_name and not devmode %}
                <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary me-3">Logout</a>
                <span class="navbar-text">{{ greeting }}, <strong>{{ user_name }}</strong></span>
            {% endif %}
        </div>
    </div>
    <!-- The clock is now below the buttons -->
    <div id="clock-container" class="text-end" style="min-height: 1.5rem;"></div>
{% endblock %}

{% block content %}
        <ul class="nav nav-tabs mt-2" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="nodes-tab" data-bs-toggle="tab" data-bs-target="#nodes-tab-pane" type="button" role="tab">Active Nodes</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="jobs-tab" data-bs-toggle="tab" data-bs-target="#jobs-tab-pane" type="button" role="tab" aria-controls="jobs-tab-pane" aria-selected="false">Job Queue</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="history-stats-tab" data-bs-toggle="tab" data-bs-target="#history-stats-tab-pane" type="button" role="tab">History & Stats</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tools-tab" data-bs-toggle="tab" data-bs-target="#tools-tab-pane" type="button" role="tab">Tools</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="options-tab" data-bs-toggle="tab" data-bs-target="#options-tab-pane" type="button" role="tab">Options</button>
            </li>
            <li class="nav-item ms-auto d-flex align-items-center d-none" id="advanced-switch-container">
                 <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="show-advanced-transcoding">
                    <label class="form-check-label" for="show-advanced-transcoding">Show Advanced Options</label>
                </div>
            </li>
        </ul>

        <div class="tab-content" id="mainTabContent">
            <!-- Nodes Tab -->
            <div class="tab-pane fade" id="nodes-tab-pane" role="tabpanel">
                <div id="db-error-alert" class="alert alert-danger mt-3 {{ 'd-none' if not db_error }}">
                    <strong>Database Error:</strong> {{ db_error }}
                </div>
                <div id="nodes-container" class="mt-3">
                    {% if nodes %}
                        {% for node in nodes %}
                        <div class="card mb-3">
                            <div class="card-header fs-5 d-flex justify-content-between align-items-center">
                                <span>{{ node.hostname }}</span>
                                <span class="badge bg-info">{{ node.version }}</span>
                            </div>
                            <div class="card-body">
                                {% if node.percent > 0 %}
                                    <p class="card-text text-body-secondary mb-2" style="font-family: monospace;">{{ node.current_file }}</p>
                                    <div class="progress" role="progressbar">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated text-bg-{{ node.color }}" style="width: {{ node.percent }}%">
                                            <b>{{ node.percent }}%</b>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="text-center p-3">
                                        <h5 class="card-title text-muted">{{ node.current_file or 'Idle' }}</h5>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="card-footer d-flex justify-content-between align-items-center bg-transparent">
                                <span class="text-muted small">Uptime: {{ node.uptime_str or 'N/A' }}</span>
                                <div>
                                {% if node.percent > 0 %}
                                    <span class="badge text-bg-secondary me-2">FPS: {{ node.fps }}</span>
                                    <span class="badge text-bg-secondary me-2">Speed: {{ node.speed }}x</span>
                                    <span class="badge text-bg-{{ node.color }}">Codec: {{ node.codec }}</span>
                                {% else %}
                                    <span class="badge text-bg-secondary">Idle</span>
                                {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center p-5">
                            <p class="text-muted">No active nodes found.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            <!-- Job Queue Tab -->
            <div class="tab-pane fade" id="jobs-tab-pane" role="tabpanel" aria-labelledby="jobs-tab" tabindex="0">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Job Queue</h1>
                    <div>
                        <div class="btn-toolbar" role="toolbar" aria-label="Job queue actions">
                            <div class="btn-group me-2" role="group" aria-label="Scan controls">
                                <button class="btn btn-primary" id="manual-scan-btn" title="Trigger a manual scan of the active media integration"><span class="mdi mdi-sync"></span> Scan Media</button>
                                <div class="input-group-text" title="Force the scanner to re-add files that are already in the queue or history">
                                    <input class="form-check-input mt-0" type="checkbox" id="force-rescan-checkbox">
                                    <label class="form-check-label ms-2" for="force-rescan-checkbox">Force</label>
                                </div>
                            </div>
                            <div class="btn-group me-2" role="group" aria-label="Main queue controls">
                                <button class="btn btn-warning" id="pause-queue-btn" title="Pause or resume the distribution of new jobs to workers"><span class="mdi mdi-pause"></span> Pause Queue</button>
                            </div>
                            <div class="btn-group me-2" role="group" aria-label="Cleanup and clear controls">
                                <button class="btn btn-info" id="release-selected-btn" title="Release selected jobs to the queue"><span class="mdi mdi-lock-open-variant"></span> Release Selected</button>
                                <button class="btn btn-info" id="release-all-cleanup-btn" title="Release all cleanup jobs awaiting approval"><span class="mdi mdi-broom"></span> Release All Cleanup</button>
                                <button class="btn btn-info" id="release-all-rename-btn" title="Release all rename jobs awaiting approval"><span class="mdi mdi-pen"></span> Release All Renames</button>
                            </div>
                            <div class="btn-group" role="group" aria-label="Clear controls">
                                <button class="btn btn-danger" id="clear-jobs-btn" title="Permanently delete all pending jobs from the queue"><span class="mdi mdi-delete-sweep"></span> Clear Queue</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="scan-status" class="mb-3"></div>
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr><th><input type="checkbox" id="select-all-cleanup" title="Select all visible jobs awaiting approval"></th><th>File Path</th><th>Type</th><th>Status</th><th>Assigned To</th><th>Created</th><th>Actions</th></tr>
                        </thead>
                        <tbody id="job-queue-table-body"></tbody>
                    </table>
                </div>
                <!-- Pagination Controls for Job Queue -->
                <nav>
                    <ul class="pagination justify-content-center" id="job-queue-pagination">
                        <!-- Pagination links will be generated by JavaScript -->
                    </ul>
                </nav>
            </div>
            <!-- History & Stats Tab -->
            <div class="tab-pane fade" id="history-stats-tab-pane" role="tabpanel">
                <div class="mt-3">
                    <!-- Stat cards will be loaded here by JavaScript -->
                    <div class="row text-center g-3" id="stats-cards-container">
                        <div class="col-12">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                    <hr class="my-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="w-50">
                            <input type="text" id="history-search-input" class="form-control" placeholder="Search by filename or node...">
                        </div>
                        <button class="btn btn-danger" id="clear-history-btn">Clear All History</button>
                    </div>
                    <!-- Full History Table -->
                    <table class="table table-hover table-sm">
                        <thead>
                            <tr>
                                <th>ID</th> <!-- This was previously Job ID -->
                                <th>File</th>
                                <th>Node</th>
                                <th>Codec</th>
                                <th>Size (GB)</th>
                                <th>Reduction</th>
                                <th>Date</th>
                                <th></th> <!-- For delete button -->
                            </tr>
                        </thead>
                        <tbody id="history-table-body"></tbody>
                    </table>
                    <nav>
                        <ul class="pagination justify-content-center" id="history-pagination">
                            <!-- Pagination links will be generated by JavaScript -->
                        </ul>
                    </nav>
                </div>
            </div>
            <!-- Options Tab -->
            <div class="tab-pane fade" id="options-tab-pane" role="tabpanel">
                <div class="mt-3">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ category }} alert-dismissible fade show mt-3" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <form method="POST" action="/options" class="mt-4">
                        <!-- Plex Settings -->
                        <div class="p-3 border rounded mb-4" id="integrations-section">
                            <h5>Integrations</h5>
                            <p class="form-text text-body-secondary">Select your primary media scanner. Only one can be active at a time.</p>
                            
                            {% set scanner_type = settings.get('media_scanner_type', {}).get('setting_value', 'plex') %}
                            <div class="mb-3">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="media_scanner_type" id="scanner_plex" value="plex" {{ 'checked' if scanner_type == 'plex' }}>
                                    <label class="form-check-label" for="scanner_plex">Plex</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="media_scanner_type" id="scanner_internal" value="internal" {{ 'checked' if scanner_type == 'internal' }}>
                                    <label class="form-check-label" for="scanner_internal">Internal Media Scanner</label>
                                </div>
                            </div>

                            <ul class="nav nav-tabs" id="integrationsTab" role="tablist">
                                <li class="nav-item" role="presentation"><button class="nav-link active" id="plex-integration-tab" data-bs-toggle="tab" data-bs-target="#plex-integration-pane" type="button">Plex</button></li>
                                <li class="nav-item" role="presentation"><button class="nav-link" id="internal-integration-tab" data-bs-toggle="tab" data-bs-target="#internal-integration-pane" type="button">Internal</button></li>
                                <li class="nav-item" role="presentation"><button class="nav-link" id="sonarr-integration-tab" data-bs-toggle="tab" data-bs-target="#sonarr-integration-pane" type="button">Sonarr</button></li>
                                <li class="nav-item" role="presentation"><button class="nav-link" id="radarr-integration-tab" data-bs-toggle="tab" data-bs-target="#radarr-integration-pane" type="button">Radarr</button></li>
                                <li class="nav-item" role="presentation"><button class="nav-link" id="lidarr-integration-tab" data-bs-toggle="tab" data-bs-target="#lidarr-integration-pane" type="button">Lidarr</button></li>
                            </ul>

                            <div class="tab-content border border-top-0 p-3" id="integrationsTabContent">
                                <!-- Plex Tab -->
                                <div class="tab-pane fade show active" id="plex-integration-pane" role="tabpanel">
                                    {% set plex_token = settings.get('plex_token', {}).get('setting_value') %}
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <div class="mb-3">
                                                <label for="plex_url" class="form-label"><strong>Plex Server URL</strong></label>
                                                <input type="text" class="form-control" id="plex_url" name="plex_url" value="{{ settings.get('plex_url', {}).get('setting_value', '') }}" placeholder="http://192.168.1.100:32400">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label"><strong>Authentication</strong></label>
                                                <div>
                                                    {% if plex_token %}
                                                        <button type="button" class="btn btn-danger" id="plex-logout-btn">Unlink Plex Account</button>
                                                        <div class="mt-2 text-success">✓ Account Linked</div>
                                                    {% else %}
                                                        <button type="button" class="btn btn-primary" id="plex-login-btn">Link Plex Account</button>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3" id="plex-libraries-container" {% if not plex_token %}style="display: none;"{% endif %}>
                                            <label class="form-label"><strong>Monitored Libraries</strong></label>
                                            <div class="form-check form-switch float-end">
                                                <input class="form-check-input" type="checkbox" role="switch" id="plex-show-hidden-toggle">
                                                <label class="form-check-label" for="plex-show-hidden-toggle">Show Hidden</label>
                                            </div>
                                            <div id="plex-libraries-list" class="border rounded p-2" style="max-height: 150px; overflow-y: auto;"></div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Internal Scanner Tab -->
                                <div class="tab-pane fade" id="internal-integration-pane" role="tabpanel">
                                    <label class="form-label"><strong>Monitored Folders</strong></label>
                                    <div class="form-check form-switch float-end">
                                        <input class="form-check-input" type="checkbox" role="switch" id="internal-show-hidden-toggle">
                                        <label class="form-check-label" for="internal-show-hidden-toggle">Show Hidden</label>
                                    </div>
                                    <p class="form-text text-body-secondary">Select which folders inside your main <code>/media</code> directory you want to scan.</p>
                                    <div id="internal-folders-list" class="border rounded p-2" style="max-height: 200px; overflow-y: auto;"></div>
                                </div>
                                <!-- Sonarr Tab -->
                                <div class="tab-pane fade" id="sonarr-integration-pane" role="tabpanel">
                                    <div class="form-check form-switch mb-3">
                                        {% set sonarr_enabled = settings.get('sonarr_enabled', {}).get('setting_value', 'false') == 'true' %}
                                        <input class="form-check-input" type="checkbox" role="switch" id="sonarr_enabled" name="sonarr_enabled" value="true" {{ 'checked' if sonarr_enabled }}>
                                        <label class="form-check-label" for="sonarr_enabled"><strong>Enable Sonarr Integration</strong></label>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label for="sonarr_host" class="form-label"><strong>Sonarr Host URL</strong></label>
                                            <input type="text" class="form-control" id="sonarr_host" name="sonarr_host" value="{{ settings.get('sonarr_host', {}).get('setting_value', '') }}" placeholder="http://sonarr:8989">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="sonarr_api_key" class="form-label"><strong>API Key</strong></label>
                                            <input type="password" class="form-control" id="sonarr_api_key" name="sonarr_api_key" value="{{ settings.get('sonarr_api_key', {}).get('setting_value', '') }}">
                                        </div>
                                        <div class="col-md-4">
                                            {# Convert stored minutes to hours for the slider #}
                                            {% set rescan_hours = (settings.get('sonarr_rescan_minutes', {}).get('setting_value', '60') | int) / 60 %}
                                            <label for="sonarr_rescan_hours" class="form-label"><strong>Rescan Time: <span id="sonarr-rescan-value">{{ rescan_hours | round | int }}</span> hr(s)</strong></label>
                                            <input type="range" class="form-range" id="sonarr_rescan_hours" name="sonarr_rescan_hours" min="1" max="24" step="1" value="{{ rescan_hours | round | int }}">
                                        </div>
                                    </div>
                                    <div class="form-check form-switch my-3">
                                        {% set sonarr_auto_scan = settings.get('sonarr_auto_scan_enabled', {}).get('setting_value', 'false') == 'true' %}
                                        <input class="form-check-input" type="checkbox" role="switch" id="sonarr_auto_scan_enabled" name="sonarr_auto_scan_enabled" value="true" {{ 'checked' if sonarr_auto_scan }}>
                                        <label class="form-check-label" for="sonarr_auto_scan_enabled"><strong>Enable Automatic Scanning</strong></label>
                                        <p class="form-text text-body-secondary">If enabled, the dashboard will automatically run the 'Scan for Renames' and 'Scan for Quality Mismatches' functions at the specified interval.</p>
                                    </div>
                                    <div class="form-check form-switch mt-3">
                                        {% set sonarr_send_to_queue = settings.get('sonarr_send_to_queue', {}).get('setting_value', 'false') == 'true' %}
                                        <input class="form-check-input" type="checkbox" role="switch" id="sonarr_send_to_queue" name="sonarr_send_to_queue" value="true" {{ 'checked' if sonarr_send_to_queue }}>
                                        <label class="form-check-label" for="sonarr_send_to_queue"><strong>Create Rename Jobs in Queue</strong></label>
                                        <p class="form-text text-body-secondary">If enabled, creates 'Rename Job' entries in the job queue that require approval. If disabled, files are renamed directly via the Sonarr API.</p>
                                    </div>
                                    <div class="form-check form-switch mb-3">
                                        {% set sonarr_auto_rename = settings.get('sonarr_auto_rename_after_transcode', {}).get('setting_value', 'false') == 'true' %}
                                        <input class="form-check-input" type="checkbox" role="switch" id="sonarr_auto_rename_after_transcode" name="sonarr_auto_rename_after_transcode" value="true" {{ 'checked' if sonarr_auto_rename }}>
                                        <label class="form-check-label" for="sonarr_auto_rename_after_transcode"><strong>Auto-Rename After Transcode</strong></label>
                                        <p class="form-text text-body-secondary">When a transcode completes, automatically trigger Sonarr to rescan the file and rename it if your naming format includes codec information (e.g., x265). This follows the renamarr pattern: rescan → update media info → rename.</p>
                                    </div>

                                    <button type="button" class="btn btn-secondary mt-3" onclick="testArrConnection('sonarr')"><span class="mdi mdi-lan-check"></span> Test Connection</button>
                                    <div id="sonarr-test-status" class="mt-2"></div>
                                </div>
                                <!-- Radarr Tab -->
                                <div class="tab-pane fade" id="radarr-integration-pane" role="tabpanel">
                                    <div class="form-check form-switch mb-3">
                                        {% set radarr_enabled = settings.get('radarr_enabled', {}).get('setting_value', 'false') == 'true' %}
                                        <input class="form-check-input" type="checkbox" role="switch" id="radarr_enabled" name="radarr_enabled" value="true" {{ 'checked' if radarr_enabled }}>
                                        <label class="form-check-label" for="radarr_enabled"><strong>Enable Radarr Integration</strong></label>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="radarr_host" class="form-label"><strong>Radarr Host URL</strong></label>
                                            <input type="text" class="form-control" id="radarr_host" name="radarr_host" value="{{ settings.get('radarr_host', {}).get('setting_value', '') }}" placeholder="http://radarr:7878">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="radarr_api_key" class="form-label"><strong>API Key</strong></label>
                                            <input type="password" class="form-control" id="radarr_api_key" name="radarr_api_key" value="{{ settings.get('radarr_api_key', {}).get('setting_value', '') }}">
                                        </div>
                                    </div>
                                    <div class="form-check form-switch mt-3">
                                        {% set radarr_send_to_queue = settings.get('radarr_send_to_queue', {}).get('setting_value', 'false') == 'true' %}
                                        <input class="form-check-input" type="checkbox" role="switch" id="radarr_send_to_queue" name="radarr_send_to_queue" value="true" {{ 'checked' if radarr_send_to_queue }}>
                                        <label class="form-check-label" for="radarr_send_to_queue"><strong>Create Rename Jobs in Queue</strong></label>
                                        <p class="form-text text-body-secondary">If enabled, creates 'Rename Job' entries in the job queue that require approval. If disabled, files are renamed directly via the Radarr API.</p>
                                    </div>
                                    <div class="form-check form-switch mb-3">
                                        {% set radarr_auto_rename = settings.get('radarr_auto_rename_after_transcode', {}).get('setting_value', 'false') == 'true' %}
                                        <input class="form-check-input" type="checkbox" role="switch" id="radarr_auto_rename_after_transcode" name="radarr_auto_rename_after_transcode" value="true" {{ 'checked' if radarr_auto_rename }}>
                                        <label class="form-check-label" for="radarr_auto_rename_after_transcode"><strong>Auto-Rename After Transcode</strong></label>
                                        <p class="form-text text-body-secondary">When a transcode completes, automatically trigger Radarr to rescan the file and rename it if your naming format includes codec information (e.g., x265). This follows the renamarr pattern: rescan → update media info → rename.</p>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-3" onclick="testArrConnection('radarr')"><span class="mdi mdi-lan-check"></span> Test Connection</button>
                                    <div id="radarr-test-status" class="mt-2"></div>
                                </div>
                                <!-- Lidarr Tab -->
                                <div class="tab-pane fade" id="lidarr-integration-pane" role="tabpanel">
                                    <div class="form-check form-switch mb-3">
                                        {% set lidarr_enabled = settings.get('lidarr_enabled', {}).get('setting_value', 'false') == 'true' %}
                                        <input class="form-check-input" type="checkbox" role="switch" id="lidarr_enabled" name="lidarr_enabled" value="true" {{ 'checked' if lidarr_enabled }}>
                                        <label class="form-check-label" for="lidarr_enabled"><strong>Enable Lidarr Integration</strong></label>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="lidarr_host" class="form-label"><strong>Lidarr Host URL</strong></label>
                                            <input type="text" class="form-control" id="lidarr_host" name="lidarr_host" value="{{ settings.get('lidarr_host', {}).get('setting_value', '') }}" placeholder="http://lidarr:8686">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="lidarr_api_key" class="form-label"><strong>API Key</strong></label>
                                            <input type="password" class="form-control" id="lidarr_api_key" name="lidarr_api_key" value="{{ settings.get('lidarr_api_key', {}).get('setting_value', '') }}">
                                        </div>
                                    </div>
                                    <div class="form-check form-switch mt-3">
                                        {% set lidarr_send_to_queue = settings.get('lidarr_send_to_queue', {}).get('setting_value', 'false') == 'true' %}
                                        <input class="form-check-input" type="checkbox" role="switch" id="lidarr_send_to_queue" name="lidarr_send_to_queue" value="true" {{ 'checked' if lidarr_send_to_queue }}>
                                        <label class="form-check-label" for="lidarr_send_to_queue"><strong>Create Rename Jobs in Queue</strong></label>
                                        <p class="form-text text-body-secondary">If enabled, creates 'Rename Job' entries in the job queue that require approval. If disabled, files are renamed directly via the Lidarr API.</p>
                                    </div>
                                    <button type="button" class="btn btn-secondary mt-3" onclick="testArrConnection('lidarr')"><span class="mdi mdi-lan-check"></span> Test Connection</button>
                                    <div id="lidarr-test-status" class="mt-2"></div>
                                </div>
                            </div>
                        </div>
                        <!-- Path Mappings -->
                        <div class="p-3 border rounded mb-4">
                            <h5>Path Mappings</h5>
                            <div class="d-flex justify-content-between align-items-center">
                            <p class="form-text text-body-secondary">Translate paths from what the media scanner sees to what the container sees. Useful if your media is on a NAS (e.g., `/nfs/media` -> `/media`).</p>
                                <div class="form-check form-switch" id="path-mapping-toggle-container">
                                    {% set mapping_enabled = settings.get('plex_path_mapping_enabled', {}).get('setting_value', 'true') == 'true' %}
                                    <input class="form-check-input" type="checkbox" role="switch" id="plex_path_mapping_enabled" name="plex_path_mapping_enabled" value="true" {{ 'checked' if mapping_enabled }}>
                                    <label class="form-check-label" for="plex_path_mapping_enabled">
                                        <strong>Enable</strong>
                                        <span class="mdi mdi-help-circle-outline" data-bs-toggle="tooltip" data-bs-placement="top" title="Enable to manually map paths. Disable if your Plex paths are identical to your container paths."></span>
                                    </label>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="plex_path_from" class="form-label">
                                        <strong id="path-from-label">Path in Plex</strong>
                                        <span class="mdi mdi-help-circle-outline" data-bs-toggle="tooltip" data-bs-placement="top" id="path-from-tooltip" title="The absolute path to your media as seen by the Plex server. e.g., /data/movies"></span>
                                    </label>
                                    <input type="text" class="form-control" id="plex_path_from" name="plex_path_from" value="{{ settings.get('plex_path_from', {}).get('setting_value', '') }}" placeholder="/nfs/media/">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="plex_path_to" class="form-label">
                                        <strong>Path in Container</strong>
                                        <span class="mdi mdi-help-circle-outline" data-bs-toggle="tooltip" data-bs-placement="top" title="The corresponding path inside the CodecShift container. This should match your Docker volume mapping. e.g., /media"></span>
                                    </label>
                                    <input type="text" class="form-control" id="plex_path_to" name="plex_path_to" value="{{ settings.get('plex_path_to', {}).get('setting_value', '') }}" placeholder="/media/">
                                </div>
                            </div>
                        </div>

                        <!-- Rescan Delay Setting -->
                        <div class="row">
                            <!-- Left Column -->
                            <div class="col-md-6">
                                <div class="mb-3 p-3 border rounded">
                                    <h5>UI Options</h5>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" id="clock-24hr" name="clock_24hr" value="true" {{ 'checked' if settings.get('clock_24hr', {}).get('setting_value', 'true') == 'true' }}>
                                        <label class="form-check-label" for="clock-24hr">Use 24-Hour Clock</label>
                                    </div>
                                </div>
                                <div class="mb-3 p-3 border rounded">
                                    <h5>Maintenance</h5>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" id="auto_update" name="auto_update" value="true" {{ 'checked' if settings.get('auto_update', {}).get('setting_value') == 'true' }}>
                                        <label class="form-check-label" for="auto_update">Enable Worker Auto-Update</label>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" id="clean_failures" name="clean_failures" value="true" {{ 'checked' if settings.get('clean_failures', {}).get('setting_value') == 'true' }}>
                                        <label class="form-check-label" for="clean_failures">Clean Failed Jobs on Start</label>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" id="debug" name="debug" value="true" {{ 'checked' if settings.get('debug', {}).get('setting_value') == 'true' }}>
                                        <label class="form-check-label" for="debug">Enable Debug Logging</label>
                                    </div>
                                </div>
                                <div class="mb-3 p-3 border rounded">
                                    <h5>File Handling</h5>
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" type="checkbox" role="switch" id="keep_original" name="keep_original" value="true" {{ 'checked' if settings.get('keep_original', {}).get('setting_value') == 'true' }}>
                                        <label class="form-check-label" for="keep_original"><strong>Keep Original File</strong></label>
                                    </div>
                                    <label for="backup_directory" class="form-label"><strong>Backup Directory</strong></label>
                                    <p class="form-text text-body-secondary">If specified, move original files here instead of deleting them. Requires "Keep Original" to be off.</p>
                                    <input type="text" class="form-control" id="backup_directory" name="backup_directory" value="{{ settings.get('backup_directory', {}).get('setting_value', '') }}" placeholder="/path/to/backups">
                                </div>
                            </div>
                            <!-- Right Column -->
                            <div class="col-md-6">
                                <div class="mb-3 p-3 border rounded">
                                    <h5>Transcoding &amp; System</h5>
                                    <label for="rescan_delay_minutes" class="form-label"><strong>Automatic Rescan Delay</strong></label>
                                    <p class="form-text text-body-secondary">Time in minutes between automatic Plex library scans. Set to 0 to disable automatic scanning.</p>
                                    <input type="number" class="form-control" id="rescan_delay_minutes" name="rescan_delay_minutes" value="{{ settings.get('rescan_delay_minutes', {}).get('setting_value', '0') }}" min="0">
                                    <hr>
                                    <label for="worker_poll_interval" class="form-label"><strong>Worker Poll Interval</strong></label>
                                    <p class="form-text text-body-secondary">Time in seconds a worker waits before asking for a new job when the queue is empty.</p>
                                    <input type="number" class="form-control" id="worker_poll_interval" name="worker_poll_interval" value="{{ settings.get('worker_poll_interval', {}).get('setting_value', '30') }}" min="5">
                                    <hr>
                                    <label for="min_length" class="form-label"><strong>Minimum Video Length</strong></label>
                                    <p class="form-text text-body-secondary">Only transcode videos longer than this duration in minutes.</p>
                                    <input type="number" class="form-control" id="min_length" name="min_length" value="{{ settings.get('min_length', {}).get('setting_value', 0.5) }}" step="0.1">
                                    <hr>
                                    <label class="form-label"><strong>Hardware Acceleration</strong></label>
                                    <p class="form-text text-body-secondary">Force a specific hardware encoder. 'Auto' lets the worker decide.</p>
                                    {% set accel = settings.get('hardware_acceleration', {}).get('setting_value', 'auto') %}
                                    <div class="form-check"><input class="form-check-input" type="radio" name="hardware_acceleration" id="accel_auto" value="auto" {{ 'checked' if accel == 'auto' }}><label class="form-check-label" for="accel_auto">Auto</label></div>
                                    <div class="form-check"><input class="form-check-input" type="radio" name="hardware_acceleration" id="accel_nvidia" value="nvidia" {{ 'checked' if accel == 'nvidia' }}><label class="form-check-label" for="accel_nvidia">NVIDIA NVENC</label></div>
                                    <div class="form-check"><input class="form-check-input" type="radio" name="hardware_acceleration" id="accel_qsv" value="qsv" {{ 'checked' if accel == 'qsv' }}><label class="form-check-label" for="accel_qsv">Intel QSV</label></div>
                                    <div class="form-check"><input class="form-check-input" type="radio" name="hardware_acceleration" id="accel_vaapi" value="vaapi" {{ 'checked' if accel == 'vaapi' }}><label class="form-check-label" for="accel_vaapi">VA-API</label></div>
                                    <div class="form-check"><input class="form-check-input" type="radio" name="hardware_acceleration" id="accel_cpu" value="cpu" {{ 'checked' if accel == 'cpu' }}><label class="form-check-label" for="accel_cpu">CPU Only</label></div>
                                    <hr>
                                    <label class="form-label"><strong>Codecs Eligible for Re-Encoding</strong></label>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" id="allow_hevc" name="allow_hevc" value="true" {{ 'checked' if settings.get('allow_hevc', {}).get('setting_value') == 'true' }}>
                                        <label class="form-check-label" for="allow_hevc">Allow HEVC (H.265)</label>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" id="allow_av1" name="allow_av1" value="true" {{ 'checked' if settings.get('allow_av1', {}).get('setting_value') == 'true' }}>
                                        <label class="form-check-label" for="allow_av1">Allow AV1</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr class="my-4">
                        <div id="advanced-transcoding-section" class="d-none">
                            <h5>Advanced Transcoding Settings</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3 p-3 border rounded">
                                        <label class="form-label"><strong>Constant Quality (CQ / CRF)</strong></label>
                                        <p class="form-text text-body-secondary">Lower is higher quality. NVENC: 0-51. VAAPI/CPU: 0-63.</p>
                                        <div class="input-group input-group-sm mb-2">
                                            <span class="input-group-text" style="width: 120px;">NVIDIA (HD)</span>
                                            <input type="number" class="form-control" name="nvenc_cq_hd" value="{{ settings.get('nvenc_cq_hd', {}).get('setting_value', 32) }}">
                                            <span class="input-group-text" style="width: 120px;">NVIDIA (SD)</span>
                                            <input type="number" class="form-control" name="nvenc_cq_sd" value="{{ settings.get('nvenc_cq_sd', {}).get('setting_value', 28) }}">
                                        </div>
                                        <div class="input-group input-group-sm mb-2">
                                            <span class="input-group-text" style="width: 120px;">Intel/AMD (HD)</span>
                                            <input type="number" class="form-control" name="vaapi_cq_hd" value="{{ settings.get('vaapi_cq_hd', {}).get('setting_value', 28) }}">
                                            <span class="input-group-text" style="width: 120px;">Intel/AMD (SD)</span>
                                            <input type="number" class="form-control" name="vaapi_cq_sd" value="{{ settings.get('vaapi_cq_sd', {}).get('setting_value', 24) }}">
                                        </div>
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text" style="width: 120px;">CPU (HD)</span>
                                            <input type="number" class="form-control" name="cpu_cq_hd" value="{{ settings.get('cpu_cq_hd', {}).get('setting_value', 28) }}">
                                            <span class="input-group-text" style="width: 120px;">CPU (SD)</span>
                                            <input type="number" class="form-control" name="cpu_cq_sd" value="{{ settings.get('cpu_cq_sd', {}).get('setting_value', 24) }}">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3 p-3 border rounded">
                                        <label for="cq_width_threshold" class="form-label"><strong>HD Width Threshold</strong></label>
                                        <p class="form-text text-body-secondary">Videos wider than this (in pixels) use the "HD" quality setting.</p>
                                        <input type="number" class="form-control" id="cq_width_threshold" name="cq_width_threshold" value="{{ settings.get('cq_width_threshold', {}).get('setting_value', 1900) }}">                                    
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Settings</button>
                    </form>
                </div>
            </div>
            <!-- Tools Tab -->
            <div class="tab-pane fade" id="tools-tab-pane" role="tabpanel">
                <div class="mt-3">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Tools</h1>
                    </div>

                    <!-- Sonarr Tools Section -->
                    <div class="p-3 border rounded mb-4">
                        {% if settings.get('sonarr_enabled', {}).get('setting_value') == 'true' %}
                            <h5>Sonarr Tools</h5>
                            <p class="form-text text-body-secondary">Run manual scans against your Sonarr instance.</p>
                            <div class="d-flex justify-content-start align-items-center mb-3">
                                <button id="sonarr-rename-scan-button" class="btn btn-primary me-2"><i class="mdi mdi-pen me-1"></i>Scan for Renames</button>
                                <button id="sonarr-quality-scan-button" class="btn btn-info me-2"><i class="mdi mdi-television-classic me-1"></i>Scan for Quality</button>
                                <button id="sonarr-cancel-scan-button" class="btn btn-danger" style="display: none;"><i class="mdi mdi-cancel me-1"></i>Cancel Scan</button>
                            </div>

                            <!-- Feedback & Progress for Rename Scan -->
                            <div id="sonarr-rename-scan-container" class="alert alert-success mt-3 progress-box" style="display: none;">
                                <div id="sonarr-rename-scan-feedback" class="mb-2"></div>
                                <div id="sonarr-rename-scan-progress">
                                    <p id="sonarr-rename-scan-progress-text" class="mb-1">Scanning for renames...</p>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar" style="width: 0%;">0%</div>
                                    </div>
                                    <small id="sonarr-rename-scan-time" class="text-muted"></small>
                                </div>
                            </div>

                            <!-- Feedback & Progress for Quality Scan -->
                            <div id="sonarr-quality-scan-container" class="alert alert-info mt-3 progress-box" style="display: none;">
                                <div id="sonarr-quality-scan-feedback" class="mb-2"></div>
                                <div id="sonarr-quality-scan-progress">
                                    <p id="sonarr-quality-scan-progress-text" class="mb-1">Scanning for quality mismatches...</p>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" role="progressbar" style="width: 0%;">0%</div>
                                    </div>
                                    <small id="sonarr-quality-scan-time" class="text-muted"></small>
                                </div>
                            </div>

                        {% else %}
                            <h5>Sonarr Tools <span class="badge bg-secondary">Disabled</span></h5>
                            <p class="form-text text-body-secondary">
                                To use these tools, please 
                                <a href="#" id="enable-sonarr-link">enable the Sonarr integration in the Options tab</a>.
                            </p>
                        {% endif %}
                    </div>

                    <!-- Radarr Tools Section -->
                    <div class="p-3 border rounded mb-4">
                        {% if settings.get('radarr_enabled', {}).get('setting_value') == 'true' %}
                            <h5>Radarr Tools</h5>
                            <p class="form-text text-body-secondary">Run manual scans against your Radarr instance.</p>
                            <div class="d-flex justify-content-start align-items-center mb-3">
                                <button id="radarr-rename-scan-button" class="btn btn-primary me-2"><i class="mdi mdi-pen me-1"></i>Scan for Renames</button>
                                <button id="radarr-cancel-scan-button" class="btn btn-danger" style="display: none;"><i class="mdi mdi-cancel me-1"></i>Cancel Scan</button>
                            </div>

                            <!-- Feedback & Progress for Radarr Rename Scan -->
                            <div id="radarr-rename-scan-container" class="alert alert-success mt-3 progress-box" style="display: none;">
                                <div id="radarr-rename-scan-feedback" class="mb-2"></div>
                                <div id="radarr-rename-scan-progress">
                                    <p id="radarr-rename-scan-progress-text" class="mb-1">Scanning for renames...</p>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar" style="width: 0%;">0%</div>
                                    </div>
                                    <small id="radarr-rename-scan-time" class="text-muted"></small>
                                </div>
                            </div>

                        {% else %}
                            <h5>Radarr Tools <span class="badge bg-secondary">Disabled</span></h5>
                            <p class="form-text text-body-secondary">
                                To use these tools, please 
                                <a href="#" id="enable-radarr-link">enable the Radarr integration in the Options tab</a>.
                            </p>
                        {% endif %}
                    </div>

                    <!-- Lidarr Tools Section -->
                    <div class="p-3 border rounded mb-4">
                        {% if settings.get('lidarr_enabled', {}).get('setting_value') == 'true' %}
                            <h5>Lidarr Tools</h5>
                            <p class="form-text text-body-secondary">Run manual scans against your Lidarr instance.</p>
                            <div class="d-flex justify-content-start align-items-center mb-3">
                                <button id="lidarr-rename-scan-button" class="btn btn-primary me-2"><i class="mdi mdi-pen me-1"></i>Scan for Renames</button>
                                <button id="lidarr-cancel-scan-button" class="btn btn-danger" style="display: none;"><i class="mdi mdi-cancel me-1"></i>Cancel Scan</button>
                            </div>

                            <!-- Feedback & Progress for Lidarr Rename Scan -->
                            <div id="lidarr-rename-scan-container" class="alert alert-success mt-3 progress-box" style="display: none;">
                                <div id="lidarr-rename-scan-feedback" class="mb-2"></div>
                                <div id="lidarr-rename-scan-progress">
                                    <p id="lidarr-rename-scan-progress-text" class="mb-1">Scanning for renames...</p>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar" style="width: 0%;">0%</div>
                                    </div>
                                    <small id="lidarr-rename-scan-time" class="text-muted"></small>
                                </div>
                            </div>

                        {% else %}
                            <h5>Lidarr Tools <span class="badge bg-secondary">Disabled</span></h5>
                            <p class="form-text text-body-secondary">
                                To use these tools, please 
                                <a href="#" id="enable-lidarr-link">enable the Lidarr integration in the Options tab</a>.
                            </p>
                        {% endif %}
                    </div>

                    <!-- System Cleanup Section -->
                    <div class="p-3 border rounded mb-4">
                        <h5>System Cleanup</h5>
                        <p class="form-text text-body-secondary">This tool creates jobs for workers to clean up stale files left behind by crashed or improperly stopped workers. This includes temporary encode files (<code>.tmp_*</code>) and file locks (<code>.lock</code>).</p>
                        <button class="btn btn-warning" id="create-cleanup-jobs-btn">Queue Stale File Cleanup</button>
                        <div id="cleanup-status" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
{% endblock %}

{% block scripts %}
    <!-- Modals -->
    {% include 'modals/failures_modal.html' %}
    {% include 'modals/node_options_modal.html' %}
    {% include 'modals/plex_login_modal.html' %}
    {% include 'modals/changelog_modal.html' %}

    <!-- Pass server-side data to JavaScript -->
    <script>
        window.CodecShift = {
            settings: {
                use24HourClock: {{ (settings.get('clock_24hr', {}).get('setting_value', 'true') == 'true') | tojson }},
                plexToken: "{{ settings.get('plex_token', {}).get('setting_value', '') }}",
                plexLibraries: "{{ settings.get('plex_libraries', {}).get('setting_value', '') }}".split(',').filter(Boolean),
                internalScanPaths: "{{ settings.get('internal_scan_paths', {}).get('setting_value', '') }}".split(',').filter(Boolean)
            },
            version: "{{ version }}"
        };
    </script>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Main Application Script -->
    <script src="{{ url_for('static', filename='js/app.js') }}" defer></script>
{% endblock %}