{% extends "base.html" %}

{% block head %}
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        .progress {
            height: 25px;
            font-size: 0.9rem;
        }
        /* Flexbox layout to push footer down */
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        /* Dev Mode Banner */
        .dev-mode-banner {
            position: fixed;
            top: 25px;
            left: -50px;
            background-color: #ffc107; /* Bootstrap 'warning' yellow */
            color: #000;
            padding: 5px 50px;
            transform: rotate(-45deg);
            font-weight: bold;
            font-size: 0.8rem;
            text-align: center;
            z-index: 1056; /* Higher than modals */
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border: 1px solid rgba(0,0,0,0.2);
        }
        /* Custom teal progress bar color */
        .progress-bar.bg-teal,
        .progress-bar-teal {
            background-color: #1EE4A9 !important;
        }
        .text-bg-teal {
            background-color: #1EE4A9 !important;
            color: #000 !important;
        }
    </style>
{% endblock %}

{% block page_title %}
    {% if devmode %}
        <div class="dev-mode-banner">DEV MODE</div>
    {% endif %}
    <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="d-flex align-items-center">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="Librarrarian Logo" style="height: 40px;" class="me-3">
        </div>
        <div class="btn-toolbar" role="toolbar">
            <!-- Theme Switcher Dropdown -->
            <div class="dropdown me-2">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="themeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <span id="theme-icon" class="mdi"></span> Theme
                </button>
                <ul class="dropdown-menu" aria-labelledby="themeDropdown">
                    <li><button class="dropdown-item d-flex align-items-center" type="button" data-theme-value="light"><span class="mdi mdi-weather-sunny me-2"></span> Light</button></li>
                    <li><button class="dropdown-item d-flex align-items-center" type="button" data-theme-value="dark"><span class="mdi mdi-weather-night me-2"></span> Dark</button></li>
                    <li><button class="dropdown-item d-flex align-items-center" type="button" data-theme-value="auto"><span class="mdi mdi-desktop-classic me-2"></span> System</button></li>
                </ul>
            </div>
            <div class="btn-group me-2" role="group">
                <button type="button" class="btn btn-outline-secondary" id="view-errors-btn" data-bs-toggle="modal" data-bs-target="#failuresModal">
                    View Errors <span class="badge" id="fail-count-badge"></span>
                </button>
                <button type="button" class="btn btn-outline-danger" id="clear-errors-btn" title="Clear All Errors">
                    &times;
                </button>
            </div>
            {% if auth_enabled and user_name and not devmode %}
                <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary me-3">Logout</a>
                <span class="navbar-text">{{ greeting }}, <strong>{{ user_name }}</strong></span>
            {% endif %}
        </div>
    </div>
    <!-- The clock is now below the buttons -->
    <div id="clock-container" class="text-end" style="min-height: 1.5rem;"></div>
{% endblock %}

{% block content %}
        <ul class="nav nav-tabs mt-2" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="nodes-tab" data-bs-toggle="tab" data-bs-target="#nodes-tab-pane" type="button" role="tab">Active Nodes</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="jobs-tab" data-bs-toggle="tab" data-bs-target="#jobs-tab-pane" type="button" role="tab" aria-controls="jobs-tab-pane" aria-selected="false">Job Queue</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="history-stats-tab" data-bs-toggle="tab" data-bs-target="#history-stats-tab-pane" type="button" role="tab">History & Stats</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tools-tab" data-bs-toggle="tab" data-bs-target="#tools-tab-pane" type="button" role="tab">Tools</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="options-tab" data-bs-toggle="tab" data-bs-target="#options-tab-pane" type="button" role="tab">Options</button>
            </li>
            <li class="nav-item ms-auto d-flex align-items-center d-none" id="global-node-controls">
                <div class="btn-group btn-group-sm" role="group" aria-label="Global node controls" style="gap: 4px;">
                    <button type="button" class="btn btn-outline-success" id="start-all-nodes-btn" title="Start all idle nodes">
                        <span class="mdi mdi-play"></span> Start All
                    </button>
                    <button type="button" class="btn btn-outline-danger" id="stop-all-nodes-btn" title="Stop all running nodes">
                        <span class="mdi mdi-stop"></span> Stop All
                    </button>
                    <button type="button" class="btn btn-outline-warning" id="pause-all-nodes-btn" title="Pause all running nodes">
                        <span class="mdi mdi-pause"></span> Pause All
                    </button>
                </div>
            </li>
            <li class="nav-item ms-auto d-flex align-items-center d-none" id="advanced-switch-container">
                 <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="show-advanced-transcoding">
                    <label class="form-check-label" for="show-advanced-transcoding">Show Advanced Options</label>
                </div>
            </li>
        </ul>

        <div class="tab-content" id="mainTabContent">
            <!-- Nodes Tab -->
            <div class="tab-pane fade" id="nodes-tab-pane" role="tabpanel">
                <div id="db-error-alert" class="alert alert-danger mt-3 {{ 'd-none' if not db_error }}">
                    <strong>Database Error:</strong> {{ db_error }}
                </div>
                <div id="nodes-container" class="mt-3">
                    {% if nodes %}
                        {% for node in nodes %}
                        <div class="card mb-3">
                            <div class="card-header fs-5 d-flex justify-content-between align-items-center">
                                <span>{{ node.hostname }}</span>
                                <span class="badge badge-outline-info">{{ node.version }}</span>
                            </div>
                            <div class="card-body">
                                {% if node.percent > 0 %}
                                    <p class="card-text text-body-secondary mb-2" style="font-family: monospace;">{{ node.current_file }}</p>
                                    <div class="progress" role="progressbar">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated text-bg-teal" style="width: {{ node.percent }}%">
                                            <b>{{ node.percent }}%</b>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="text-center p-3">
                                        <h5 class="card-title text-muted">{{ node.current_file or 'Idle' }}</h5>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="card-footer d-flex justify-content-between align-items-center bg-transparent" style="font-size: 1.1rem;">
                                <div>
                                    <span class="badge badge-outline-secondary">Uptime: {{ node.uptime_str or 'N/A' }}</span>
                                </div>
                                <div>
                                {% if node.percent > 0 %}
                                    <span class="badge badge-outline-secondary me-2">FPS: {{ node.fps }}</span>
                                    <span class="badge badge-outline-secondary me-2">Speed: {{ node.speed }}x</span>
                                    <span class="badge badge-outline-teal me-2">Codec: {{ node.codec }}</span>
                                    <span class="badge badge-outline-info">ETA: {{ node.eta or 'N/A' }}</span>
                                {% else %}
                                    <span class="badge badge-outline-secondary">Idle</span>
                                {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center p-5">
                            <p class="text-muted">No active nodes found.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            <!-- Job Queue Tab -->
            <div class="tab-pane fade" id="jobs-tab-pane" role="tabpanel" aria-labelledby="jobs-tab" tabindex="0">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Job Queue</h1>
                    <div>
                        <div class="btn-toolbar" role="toolbar" aria-label="Job queue actions">
                            <div class="btn-group me-2" role="group" aria-label="Scan controls">
                                <button class="btn btn-outline-primary" id="manual-scan-btn" title="Trigger a manual scan of the active media integration"><span class="mdi mdi-sync"></span> Scan Media</button>
                                <div class="input-group-text" title="Force the scanner to re-add files that are already in the queue or history">
                                    <input class="form-check-input mt-0" type="checkbox" id="force-rescan-checkbox">
                                    <label class="form-check-label ms-2" for="force-rescan-checkbox">Force</label>
                                </div>
                            </div>
                            <div class="btn-group me-2" role="group" aria-label="Main queue controls">
                                <button class="btn btn-outline-warning" id="pause-queue-btn" title="Pause or resume the distribution of new jobs to workers"><span class="mdi mdi-pause"></span> Pause Queue</button>
                            </div>
                            <div class="btn-group me-2" role="group" aria-label="Cleanup and clear controls">
                                <button class="btn btn-outline-info" id="release-selected-btn" title="Release selected jobs to the queue"><span class="mdi mdi-lock-open-variant"></span> Release Selected</button>
                                <button class="btn btn-outline-info" id="release-all-cleanup-btn" title="Release all cleanup jobs awaiting approval"><span class="mdi mdi-broom"></span> Release All Cleanup</button>
                                <button class="btn btn-outline-info" id="release-all-rename-btn" title="Release all rename jobs awaiting approval"><span class="mdi mdi-pen"></span> Release All Renames</button>
                            </div>
                            <div class="btn-group me-2" role="group" aria-label="Clear controls">
                                <button class="btn btn-outline-danger" id="clear-jobs-btn" title="Permanently delete all pending jobs from the queue"><span class="mdi mdi-delete-sweep"></span> Clear Queue</button>
                                <div class="input-group-text" title="When enabled, will force remove all jobs regardless of status">
                                    <input class="form-check-input mt-0" type="checkbox" id="force-clear-checkbox">
                                    <label class="form-check-label ms-2" for="force-clear-checkbox">Force</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Filter Options Row -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label for="job-filter-type" class="form-label small text-muted">Filter by Type</label>
                        <select class="form-select form-select-sm" id="job-filter-type">
                            <option value="">All Types</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="job-filter-status" class="form-label small text-muted">Filter by Status</label>
                        <select class="form-select form-select-sm" id="job-filter-status">
                            <option value="">All Statuses</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-sm btn-outline-secondary" id="job-filter-clear" title="Clear all filters"><span class="mdi mdi-filter-off"></span> Clear Filters</button>
                    </div>
                </div>
                <div id="scan-status" class="mb-3"></div>
                <!-- Media Scan Progress Container -->
                <div id="media-scan-container" class="alert alert-primary mb-3" style="display: none;">
                    <div id="media-scan-feedback" class="mb-2"></div>
                    <div id="media-scan-progress">
                        <p id="media-scan-progress-text" class="mb-1">Scanning media...</p>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-teal" role="progressbar" style="width: 0%;">0%</div>
                        </div>
                        <small id="media-scan-time" class="text-muted"></small>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr><th><input type="checkbox" id="select-all-cleanup" title="Select all visible jobs awaiting approval"></th><th>File Path</th><th>Type</th><th>Status</th><th>Assigned To</th><th>Created</th><th>Actions</th></tr>
                        </thead>
                        <tbody id="job-queue-table-body"></tbody>
                    </table>
                </div>
                <!-- Pagination Controls for Job Queue -->
                <nav>
                    <ul class="pagination justify-content-center" id="job-queue-pagination">
                        <!-- Pagination links will be generated by JavaScript -->
                    </ul>
                </nav>
            </div>
            <!-- History & Stats Tab -->
            <div class="tab-pane fade" id="history-stats-tab-pane" role="tabpanel">
                <div class="mt-3">
                    <!-- Stat cards will be loaded here by JavaScript -->
                    <div class="row text-center g-3" id="stats-cards-container">
                        <div class="col-12">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                    <hr class="my-4">
                    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                        <div class="d-flex align-items-center gap-2">
                            <input type="text" id="history-search-input" class="form-control" placeholder="Search by filename or node..." style="width: 300px;">
                            <select id="history-per-page-select" class="form-select" style="width: auto;">
                                <option value="100">100 per page</option>
                                <option value="200">200 per page</option>
                                <option value="300">300 per page</option>
                                <option value="400">400 per page</option>
                                <option value="500">500 per page</option>
                                <option value="all">All</option>
                            </select>
                        </div>
                        <button class="btn btn-outline-danger" id="clear-history-btn"><span class="mdi mdi-delete-sweep"></span> Clear All History</button>
                    </div>
                    <!-- Full History Table -->
                    <table class="table table-hover table-sm">
                        <thead>
                            <tr>
                                <th style="cursor: pointer;" data-sort="id">ID <span class="mdi mdi-sort"></span></th>
                                <th style="cursor: pointer;" data-sort="filename">File <span class="mdi mdi-sort"></span></th>
                                <th style="cursor: pointer;" data-sort="hostname">Node <span class="mdi mdi-sort"></span></th>
                                <th style="cursor: pointer;" data-sort="codec">Codec <span class="mdi mdi-sort"></span></th>
                                <th style="cursor: pointer;" data-sort="original_size">Size (GB) <span class="mdi mdi-sort"></span></th>
                                <th style="cursor: pointer;" data-sort="reduction_percent">Reduction <span class="mdi mdi-sort"></span></th>
                                <th style="cursor: pointer;" data-sort="encoded_at">Date <span class="mdi mdi-sort"></span></th>
                                <th></th> <!-- For delete button -->
                            </tr>
                        </thead>
                        <tbody id="history-table-body"></tbody>
                    </table>
                    <nav>
                        <ul class="pagination justify-content-center" id="history-pagination">
                            <!-- Pagination links will be generated by JavaScript -->
                        </ul>
                    </nav>
                </div>
            </div>
            <!-- Options Tab -->
            <div class="tab-pane fade" id="options-tab-pane" role="tabpanel">
                <div class="mt-3">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ category }} alert-dismissible fade show mt-3" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <form method="POST" action="/options" class="mt-4">
                        {% set primary_media_server = settings.get('primary_media_server', {}).get('setting_value', 'plex') %}
                        {% set enable_multi_server = settings.get('enable_multi_server', {}).get('setting_value', 'false') == 'true' %}
                        {% set plex_token = settings.get('plex_token', {}).get('setting_value') %}
                        {% set jellyfin_api_key = settings.get('jellyfin_api_key', {}).get('setting_value') %}
                        
                        <!-- Primary Media Server Selection (Above Integrations) -->
                        <div class="p-3 border rounded mb-4" id="primary-media-server-section">
                            <h5>Primary Media Server</h5>
                            <p class="form-text text-body-secondary mb-3">Select your primary media scanner. Only one can be active at a time.</p>
                            
                            <div class="d-flex align-items-center gap-3 flex-wrap">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="primary_media_server" id="primary_plex" value="plex" {{ 'checked' if primary_media_server == 'plex' }}>
                                    <label class="form-check-label" for="primary_plex">Plex</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="primary_media_server" id="primary_jellyfin" value="jellyfin" {{ 'checked' if primary_media_server == 'jellyfin' }}>
                                    <label class="form-check-label" for="primary_jellyfin">Jellyfin</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="primary_media_server" id="primary_internal" value="internal" {{ 'checked' if primary_media_server == 'internal' }}>
                                    <label class="form-check-label" for="primary_internal">Internal Media Scanner</label>
                                </div>
                                <div class="form-check form-switch ms-auto">
                                    <input class="form-check-input" type="checkbox" role="switch" id="enable_multi_server" name="enable_multi_server" value="true" {{ 'checked' if enable_multi_server }}>
                                    <label class="form-check-label" for="enable_multi_server">
                                        <strong>Sync Between Plex &amp; Jellyfin</strong>
                                        <span class="mdi mdi-help-circle-outline" data-bs-toggle="tooltip" data-bs-placement="top" title="When enabled, you can configure library mappings between Plex and Jellyfin. This allows the system to scan and manage both servers' libraries together, ensuring files are queued from both sources."></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Integrations Settings -->
                        <div class="p-3 border rounded mb-4" id="integrations-section">
                            <h5>Integrations</h5>
                            
                            <ul class="nav nav-tabs" id="integrationsTab" role="tablist">
                                <li class="nav-item" role="presentation"><button class="nav-link active" id="media-servers-tab" data-bs-toggle="tab" data-bs-target="#media-servers-pane" type="button">Media Servers</button></li>
                                <li class="nav-item" role="presentation"><button class="nav-link" id="internal-integration-tab" data-bs-toggle="tab" data-bs-target="#internal-integration-pane" type="button">Internal Media Scanner</button></li>
                                <li class="nav-item" role="presentation"><button class="nav-link" id="sonarr-integration-tab" data-bs-toggle="tab" data-bs-target="#sonarr-integration-pane" type="button">Sonarr</button></li>
                                <li class="nav-item" role="presentation"><button class="nav-link" id="radarr-integration-tab" data-bs-toggle="tab" data-bs-target="#radarr-integration-pane" type="button">Radarr</button></li>
                                <li class="nav-item" role="presentation"><button class="nav-link" id="lidarr-integration-tab" data-bs-toggle="tab" data-bs-target="#lidarr-integration-pane" type="button">Lidarr</button></li>
                            </ul>

                            <div class="tab-content border border-top-0 p-3" id="integrationsTabContent">
                                <!-- Media Servers Tab -->
                                <div class="tab-pane fade show active" id="media-servers-pane" role="tabpanel">
                                    <hr class="my-4">

                                    <!-- Two-column layout: Auth on left, Libraries on right -->
                                    <div class="row">
                                        <!-- Left Column: Authentication -->
                                        <div class="col-md-6">
                                            <h6 class="mb-3"><strong>Authentication</strong></h6>
                                            
                                            <!-- Plex Auth -->
                                            <div class="mb-3">
                                                <label class="form-label">Plex</label>
                                                <div class="d-flex gap-2">
                                                    {% if plex_token %}
                                                        <button type="button" class="btn btn-outline-primary" id="plex-modify-btn"><span class="mdi mdi-cog"></span> Modify Configuration</button>
                                                    {% else %}
                                                        <button type="button" class="btn btn-outline-warning" id="plex-login-btn" style="--bs-btn-color: #e5a00d; --bs-btn-border-color: #e5a00d; --bs-btn-hover-bg: #e5a00d; --bs-btn-hover-border-color: #e5a00d;"><span class="mdi mdi-link"></span> Link Plex</button>
                                                    {% endif %}
                                                    <div class="align-self-center">
                                                        {% if plex_token %}
                                                            <span class="text-success">✓ Account Linked</span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Jellyfin Auth -->
                                            <div class="mb-3">
                                                <label class="form-label">Jellyfin</label>
                                                <div class="d-flex gap-2">
                                                    {% if jellyfin_api_key %}
                                                        <button type="button" class="btn btn-outline-primary" id="jellyfin-modify-btn"><span class="mdi mdi-cog"></span> Modify Configuration</button>
                                                    {% else %}
                                                        <button type="button" class="btn" id="jellyfin-login-btn" style="--bs-btn-color: #aa5cc3; --bs-btn-border-color: #aa5cc3; --bs-btn-hover-bg: #aa5cc3; --bs-btn-hover-border-color: #aa5cc3; --bs-btn-hover-color: #fff; border: 1px solid;"><span class="mdi mdi-link"></span> Link Jellyfin</button>
                                                    {% endif %}
                                                    <div class="align-self-center">
                                                        {% if jellyfin_api_key %}
                                                            <span class="text-success">✓ Server Linked</span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Right Column: Monitored Libraries -->
                                        <div class="col-md-6">
                                            <h6 class="mb-3"><strong>Monitored Libraries</strong></h6>
                                            
                                            <!-- Single Plex Libraries Container (used when Plex is primary and sync is disabled) -->
                                            <div id="plex-libraries-container" class="mb-3">
                                                <label class="form-label">Plex</label>
                                                <div class="form-check form-switch float-end">
                                                    <input class="form-check-input" type="checkbox" role="switch" id="plex-show-hidden-toggle">
                                                    <label class="form-check-label" for="plex-show-hidden-toggle">Show Ignored</label>
                                                </div>
                                                <div id="plex-libraries-list" class="border rounded p-2"></div>
                                            </div>

                                            <!-- Single Jellyfin Libraries Container (used when Jellyfin is primary and sync is disabled) -->
                                            <div id="jellyfin-libraries-container">
                                                <label class="form-label">Jellyfin</label>
                                                <div class="form-check form-switch float-end">
                                                    <input class="form-check-input" type="checkbox" role="switch" id="jellyfin-show-hidden-toggle">
                                                    <label class="form-check-label" for="jellyfin-show-hidden-toggle">Show Ignored</label>
                                                </div>
                                                <div id="jellyfin-libraries-list" class="border rounded p-2"></div>
                                            </div>
                                            
                                            <!-- Combined Libraries Container (used when multi-server sync is enabled) -->
                                            <div id="combined-libraries-container" style="display: none;">
                                                <label class="form-label">Libraries (Plex & Jellyfin)</label>
                                                <div class="form-check form-switch float-end">
                                                    <input class="form-check-input" type="checkbox" role="switch" id="combined-show-hidden-toggle">
                                                    <label class="form-check-label" for="combined-show-hidden-toggle">Show Ignored</label>
                                                </div>
                                                <div id="combined-libraries-list" class="border rounded p-2" style="max-height: 400px; overflow-y: auto;"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Internal Scanner Tab -->
                                <div class="tab-pane fade" id="internal-integration-pane" role="tabpanel">
                                    <label class="form-label"><strong>Monitored Folders</strong></label>
                                    <div class="form-check form-switch float-end">
                                        <input class="form-check-input" type="checkbox" role="switch" id="internal-show-hidden-toggle">
                                        <label class="form-check-label" for="internal-show-hidden-toggle">Show Ignored</label>
                                    </div>
                                    <p class="form-text text-body-secondary">Select which folders inside your main <code>/media</code> directory you want to scan.</p>
                                    <div id="internal-folders-list" class="border rounded p-2" style="max-height: 200px; overflow-y: auto;"></div>
                                </div>
                                <!-- Sonarr Tab -->
                                <div class="tab-pane fade" id="sonarr-integration-pane" role="tabpanel">
                                    <div class="form-check form-switch mb-3">
                                        {% set sonarr_enabled = settings.get('sonarr_enabled', {}).get('setting_value', 'false') == 'true' %}
                                        <input class="form-check-input" type="checkbox" role="switch" id="sonarr_enabled" name="sonarr_enabled" value="true" {{ 'checked' if sonarr_enabled }}>
                                        <label class="form-check-label" for="sonarr_enabled"><strong><span id="sonarr_enabled_label">{{ 'Disable' if sonarr_enabled else 'Enable' }}</span> Sonarr Integration</strong></label>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="sonarr_host" class="form-label"><strong>Sonarr Host URL</strong></label>
                                            <input type="text" class="form-control" id="sonarr_host" name="sonarr_host" value="{{ settings.get('sonarr_host', {}).get('setting_value', '') }}" placeholder="http://sonarr:8989">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="sonarr_api_key" class="form-label"><strong>API Key</strong></label>
                                            <input type="password" class="form-control" id="sonarr_api_key" name="sonarr_api_key" value="{{ settings.get('sonarr_api_key', {}).get('setting_value', '') }}">
                                        </div>
                                    </div>
                                    <div class="form-check form-switch mt-3">
                                        {% set sonarr_send_to_queue = settings.get('sonarr_send_to_queue', {}).get('setting_value', 'false') == 'true' %}
                                        <input class="form-check-input" type="checkbox" role="switch" id="sonarr_send_to_queue" name="sonarr_send_to_queue" value="true" {{ 'checked' if sonarr_send_to_queue }}>
                                        <label class="form-check-label" for="sonarr_send_to_queue"><strong>Create Rename Jobs in Queue</strong></label>
                                        <p class="form-text text-body-secondary">If enabled, creates 'Rename Job' entries in the job queue that require approval. If disabled, files are renamed directly via the Sonarr API.</p>
                                    </div>
                                    <div class="form-check form-switch mb-3">
                                        {% set sonarr_auto_rename = settings.get('sonarr_auto_rename_after_transcode', {}).get('setting_value', 'false') == 'true' %}
                                        <input class="form-check-input" type="checkbox" role="switch" id="sonarr_auto_rename_after_transcode" name="sonarr_auto_rename_after_transcode" value="true" {{ 'checked' if sonarr_auto_rename }}>
                                        <label class="form-check-label" for="sonarr_auto_rename_after_transcode"><strong>Auto-Rename After Transcode</strong></label>
                                        <p class="form-text text-body-secondary">When a transcode completes, automatically trigger Sonarr to rescan the file and rename it if your naming format includes codec information (e.g., x265). This follows the renamarr pattern: rescan → update media info → rename.</p>
                                    </div>

                                    <button type="button" class="btn btn-outline-secondary mt-3" onclick="testArrConnection('sonarr')"><span class="mdi mdi-lan-check"></span> Test Connection</button>
                                    <div id="sonarr-test-status" class="mt-2"></div>
                                </div>
                                <!-- Radarr Tab -->
                                <div class="tab-pane fade" id="radarr-integration-pane" role="tabpanel">
                                    <div class="form-check form-switch mb-3">
                                        {% set radarr_enabled = settings.get('radarr_enabled', {}).get('setting_value', 'false') == 'true' %}
                                        <input class="form-check-input" type="checkbox" role="switch" id="radarr_enabled" name="radarr_enabled" value="true" {{ 'checked' if radarr_enabled }}>
                                        <label class="form-check-label" for="radarr_enabled"><strong><span id="radarr_enabled_label">{{ 'Disable' if radarr_enabled else 'Enable' }}</span> Radarr Integration</strong></label>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="radarr_host" class="form-label"><strong>Radarr Host URL</strong></label>
                                            <input type="text" class="form-control" id="radarr_host" name="radarr_host" value="{{ settings.get('radarr_host', {}).get('setting_value', '') }}" placeholder="http://radarr:7878">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="radarr_api_key" class="form-label"><strong>API Key</strong></label>
                                            <input type="password" class="form-control" id="radarr_api_key" name="radarr_api_key" value="{{ settings.get('radarr_api_key', {}).get('setting_value', '') }}">
                                        </div>
                                    </div>
                                    <div class="form-check form-switch mt-3">
                                        {% set radarr_send_to_queue = settings.get('radarr_send_to_queue', {}).get('setting_value', 'false') == 'true' %}
                                        <input class="form-check-input" type="checkbox" role="switch" id="radarr_send_to_queue" name="radarr_send_to_queue" value="true" {{ 'checked' if radarr_send_to_queue }}>
                                        <label class="form-check-label" for="radarr_send_to_queue"><strong>Create Rename Jobs in Queue</strong></label>
                                        <p class="form-text text-body-secondary">If enabled, creates 'Rename Job' entries in the job queue that require approval. If disabled, files are renamed directly via the Radarr API.</p>
                                    </div>
                                    <div class="form-check form-switch mb-3">
                                        {% set radarr_auto_rename = settings.get('radarr_auto_rename_after_transcode', {}).get('setting_value', 'false') == 'true' %}
                                        <input class="form-check-input" type="checkbox" role="switch" id="radarr_auto_rename_after_transcode" name="radarr_auto_rename_after_transcode" value="true" {{ 'checked' if radarr_auto_rename }}>
                                        <label class="form-check-label" for="radarr_auto_rename_after_transcode"><strong>Auto-Rename After Transcode</strong></label>
                                        <p class="form-text text-body-secondary">When a transcode completes, automatically trigger Radarr to rescan the file and rename it if your naming format includes codec information (e.g., x265). This follows the renamarr pattern: rescan → update media info → rename.</p>
                                    </div>
                                    <button type="button" class="btn btn-outline-secondary mt-3" onclick="testArrConnection('radarr')"><span class="mdi mdi-lan-check"></span> Test Connection</button>
                                    <div id="radarr-test-status" class="mt-2"></div>
                                </div>
                                <!-- Lidarr Tab -->
                                <div class="tab-pane fade" id="lidarr-integration-pane" role="tabpanel">
                                    <div class="form-check form-switch mb-3">
                                        {% set lidarr_enabled = settings.get('lidarr_enabled', {}).get('setting_value', 'false') == 'true' %}
                                        <input class="form-check-input" type="checkbox" role="switch" id="lidarr_enabled" name="lidarr_enabled" value="true" {{ 'checked' if lidarr_enabled }}>
                                        <label class="form-check-label" for="lidarr_enabled"><strong><span id="lidarr_enabled_label">{{ 'Disable' if lidarr_enabled else 'Enable' }}</span> Lidarr Integration</strong></label>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="lidarr_host" class="form-label"><strong>Lidarr Host URL</strong></label>
                                            <input type="text" class="form-control" id="lidarr_host" name="lidarr_host" value="{{ settings.get('lidarr_host', {}).get('setting_value', '') }}" placeholder="http://lidarr:8686">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="lidarr_api_key" class="form-label"><strong>API Key</strong></label>
                                            <input type="password" class="form-control" id="lidarr_api_key" name="lidarr_api_key" value="{{ settings.get('lidarr_api_key', {}).get('setting_value', '') }}">
                                        </div>
                                    </div>
                                    <div class="form-check form-switch mt-3">
                                        {% set lidarr_send_to_queue = settings.get('lidarr_send_to_queue', {}).get('setting_value', 'false') == 'true' %}
                                        <input class="form-check-input" type="checkbox" role="switch" id="lidarr_send_to_queue" name="lidarr_send_to_queue" value="true" {{ 'checked' if lidarr_send_to_queue }}>
                                        <label class="form-check-label" for="lidarr_send_to_queue"><strong>Create Rename Jobs in Queue</strong></label>
                                        <p class="form-text text-body-secondary">If enabled, creates 'Rename Job' entries in the job queue that require approval. If disabled, files are renamed directly via the Lidarr API.</p>
                                    </div>
                                    <button type="button" class="btn btn-outline-secondary mt-3" onclick="testArrConnection('lidarr')"><span class="mdi mdi-lan-check"></span> Test Connection</button>
                                    <div id="lidarr-test-status" class="mt-2"></div>
                                </div>
                            </div>
                        </div>
                        <!-- Path Mappings -->
                        <div class="p-3 border rounded mb-4">
                            <h5>Path Mappings</h5>
                            <p class="form-text text-body-secondary">Translate paths from what your media servers (Plex/Jellyfin) see to what the Librarrarian container sees. Useful if your media is on a NAS with different mount points (e.g., `/nfs/media` -> `/media`).</p>
                            
                            <!-- Plex Path Mapping -->
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">Plex Path Mapping</h6>
                                <div class="form-check form-switch" id="path-mapping-toggle-container">
                                    {% set mapping_enabled = settings.get('plex_path_mapping_enabled', {}).get('setting_value', 'true') == 'true' %}
                                    <input class="form-check-input" type="checkbox" role="switch" id="plex_path_mapping_enabled" name="plex_path_mapping_enabled" value="true" {{ 'checked' if mapping_enabled }}>
                                    <label class="form-check-label" for="plex_path_mapping_enabled">
                                        <strong>Enable</strong>
                                        <span class="mdi mdi-help-circle-outline" data-bs-toggle="tooltip" data-bs-placement="top" title="Enable to manually map paths. Disable if your Plex paths are identical to your container paths."></span>
                                    </label>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-6 mb-3">
                                    <label for="plex_path_from" class="form-label">
                                        <strong id="path-from-label">Path in Plex</strong>
                                        <span class="mdi mdi-help-circle-outline" data-bs-toggle="tooltip" data-bs-placement="top" id="path-from-tooltip" title="The absolute path to your media as seen by the Plex server. e.g., /data/movies"></span>
                                    </label>
                                    <input type="text" class="form-control" id="plex_path_from" name="plex_path_from" value="{{ settings.get('plex_path_from', {}).get('setting_value', '') }}" placeholder="/nfs/media/">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="plex_path_to" class="form-label">
                                        <strong>Path in Container</strong>
                                        <span class="mdi mdi-help-circle-outline" data-bs-toggle="tooltip" data-bs-placement="top" title="The corresponding path inside the Librarrarian container. This should match your Docker volume mapping. e.g., /media"></span>
                                    </label>
                                    <input type="text" class="form-control" id="plex_path_to" name="plex_path_to" value="{{ settings.get('plex_path_to', {}).get('setting_value', '') }}" placeholder="/media/">
                                </div>
                            </div>
                            
                            <!-- Jellyfin Path Mapping -->
                            <div class="mt-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">Jellyfin Path Mapping</h6>
                                    <div class="form-check form-switch">
                                        {% set jellyfin_mapping_enabled = settings.get('jellyfin_path_mapping_enabled', {}).get('setting_value', 'true') == 'true' %}
                                        <input class="form-check-input" type="checkbox" role="switch" id="jellyfin_path_mapping_enabled" name="jellyfin_path_mapping_enabled" value="true" {{ 'checked' if jellyfin_mapping_enabled }}>
                                        <label class="form-check-label" for="jellyfin_path_mapping_enabled">
                                            <strong>Enable</strong>
                                            <span class="mdi mdi-help-circle-outline" data-bs-toggle="tooltip" data-bs-placement="top" title="Enable to manually map paths. Disable if your Jellyfin paths are identical to your container paths."></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-6 mb-3">
                                        <label for="jellyfin_path_from" class="form-label">
                                            <strong>Path in Jellyfin</strong>
                                            <span class="mdi mdi-help-circle-outline" data-bs-toggle="tooltip" data-bs-placement="top" title="The absolute path to your media as seen by the Jellyfin server. e.g., /data/movies"></span>
                                        </label>
                                        <input type="text" class="form-control" id="jellyfin_path_from" name="jellyfin_path_from" value="{{ settings.get('jellyfin_path_from', {}).get('setting_value', '') }}" placeholder="/nfs/media/">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="jellyfin_path_to" class="form-label">
                                            <strong>Path in Container</strong>
                                            <span class="mdi mdi-help-circle-outline" data-bs-toggle="tooltip" data-bs-placement="top" title="The corresponding path inside the Librarrarian container. This should match your Docker volume mapping. e.g., /media"></span>
                                        </label>
                                        <input type="text" class="form-control" id="jellyfin_path_to" name="jellyfin_path_to" value="{{ settings.get('jellyfin_path_to', {}).get('setting_value', '') }}" placeholder="/media/">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Rescan Delay Setting -->
                        <div class="row">
                            <!-- Left Column -->
                            <div class="col-md-6">
                                <div class="mb-3 p-3 border rounded">
                                    <h5>UI Options</h5>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" id="clock-24hr" name="clock_24hr" value="true" {{ 'checked' if settings.get('clock_24hr', {}).get('setting_value', 'true') == 'true' }}>
                                        <label class="form-check-label" for="clock-24hr">Use 24-Hour Clock</label>
                                    </div>
                                </div>
                                <div class="mb-3 p-3 border rounded">
                                    <h5>Logging Options</h5>
                                    <p class="form-text text-body-secondary">Control which types of messages appear in Docker logs.</p>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" id="hide_job_requests" name="hide_job_requests" value="true" {{ 'checked' if settings.get('hide_job_requests', {}).get('setting_value') == 'true' }}>
                                        <label class="form-check-label" for="hide_job_requests">Hide Job Requests</label>
                                        <p class="form-text text-body-secondary small">Suppress worker job request messages from logs.</p>
                                    </div>
                                    {% set plex_token = settings.get('plex_token', {}).get('setting_value') %}
                                    <div class="form-check form-switch" {% if not plex_token %}style="opacity: 0.5;"{% endif %}>
                                        <input class="form-check-input" type="checkbox" role="switch" id="hide_plex_updates" name="hide_plex_updates" value="true" {{ 'checked' if settings.get('hide_plex_updates', {}).get('setting_value') == 'true' }} {% if not plex_token %}disabled{% endif %}>
                                        <label class="form-check-label" for="hide_plex_updates">Hide Plex Updates</label>
                                        <p class="form-text text-body-secondary small">Suppress Plex library update notifications from logs.{% if not plex_token %} (Disabled: Plex not linked){% endif %}</p>
                                    </div>
                                    {% set jellyfin_api_key = settings.get('jellyfin_api_key', {}).get('setting_value') %}
                                    <div class="form-check form-switch" {% if not jellyfin_api_key %}style="opacity: 0.5;"{% endif %}>
                                        <input class="form-check-input" type="checkbox" role="switch" id="hide_jellyfin_updates" name="hide_jellyfin_updates" value="true" {{ 'checked' if settings.get('hide_jellyfin_updates', {}).get('setting_value') == 'true' }} {% if not jellyfin_api_key %}disabled{% endif %}>
                                        <label class="form-check-label" for="hide_jellyfin_updates">Hide Jellyfin Updates</label>
                                        <p class="form-text text-body-secondary small">Suppress Jellyfin library update notifications from logs.{% if not jellyfin_api_key %} (Disabled: Jellyfin not linked){% endif %}</p>
                                    </div>
                                </div>
                                <div class="mb-3 p-3 border rounded">
                                    <h5>Maintenance</h5>
                                    <h6><strong>Database Backup</strong></h6>
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" type="checkbox" role="switch" id="backup_enabled" name="backup_enabled" value="true" {{ 'checked' if settings.get('backup_enabled', {}).get('setting_value', 'true') == 'true' }}>
                                        <label class="form-check-label" for="backup_enabled"><strong>Automatic Backups</strong></label>
                                    </div>
                                    <div id="backup-schedule-fields">
                                        <label for="backup_time" class="form-label mt-2"><strong>Backup Time</strong></label>
                                        <p class="form-text text-body-secondary">Time of day (HH:MM in 24-hour format) to perform automatic daily database backups.</p>
                                        <input type="time" class="form-control" id="backup_time" name="backup_time" value="{{ settings.get('backup_time', {}).get('setting_value', '02:00') }}">
                                        
                                        <label for="backup_retention_days" class="form-label mt-3"><strong>Backup Retention (Days)</strong></label>
                                        <p class="form-text text-body-secondary">Number of backup files to keep. Older backups will be automatically deleted.</p>
                                        <input type="number" class="form-control" id="backup_retention_days" name="backup_retention_days" value="{{ settings.get('backup_retention_days', {}).get('setting_value', '7') }}" min="1" max="365">
                                    </div>
                                    
                                    <div class="btn-group mt-3" role="group">
                                        <button type="button" class="btn btn-outline-primary" id="backup-now-btn"><span class="mdi mdi-database-export"></span> Manual Backup</button>
                                        <button type="button" class="btn btn-outline-info" id="manage-backups-btn"><span class="mdi mdi-folder-open"></span> Manage Backups</button>
                                    </div>
                                    <div id="backup-status" class="mt-2"></div>
                                </div>
                                <div class="mb-3 p-3 border rounded">
                                    <h5>File Handling</h5>
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" type="checkbox" role="switch" id="keep_original" name="keep_original" value="true" {{ 'checked' if settings.get('keep_original', {}).get('setting_value') == 'true' }}>
                                        <label class="form-check-label" for="keep_original"><strong>Keep Original File</strong></label>
                                    </div>
                                    <label for="backup_directory" class="form-label"><strong>Backup Directory</strong></label>
                                    <p class="form-text text-body-secondary">If specified, move original files here instead of deleting them. Requires "Keep Original" to be off.</p>
                                    <input type="text" class="form-control" id="backup_directory" name="backup_directory" value="{{ settings.get('backup_directory', {}).get('setting_value', '') }}" placeholder="/path/to/backups">
                                </div>
                            </div>
                            <!-- Right Column -->
                            <div class="col-md-6">
                                <div class="mb-3 p-3 border rounded">
                                    <h5>Transcoding &amp; System</h5>
                                    <label for="rescan_delay_hours" class="form-label"><strong>Automatic Rescan Delay</strong></label>
                                    <p class="form-text text-body-secondary">Time in hours between automatic Plex library scans. Set to 0 to disable automatic scanning.</p>
                                    <div class="d-flex align-items-center mb-2">
                                        <input type="range" class="form-range flex-grow-1 me-3" id="rescan_delay_hours" name="rescan_delay_hours" value="{{ (settings.get('rescan_delay_minutes', {}).get('setting_value', '0') | int / 60) | round(2) }}" min="0" max="24" step="0.25">
                                        <span class="badge badge-outline-primary" id="rescan_delay_hours_value" style="min-width: 4rem; text-align: center;">0 hrs</span>
                                    </div>
                                    <label for="worker_poll_interval" class="form-label mt-3"><strong>Worker Poll Interval</strong></label>
                                    <p class="form-text text-body-secondary">Time in seconds a worker waits before asking for a new job when the queue is empty.</p>
                                    <div class="d-flex align-items-center mb-2">
                                        <input type="range" class="form-range flex-grow-1 me-3" id="worker_poll_interval" name="worker_poll_interval" value="{{ settings.get('worker_poll_interval', {}).get('setting_value', '30') }}" min="0" max="600" step="5">
                                        <span class="badge badge-outline-primary" id="worker_poll_interval_value" style="min-width: 4rem; text-align: center;">30s</span>
                                    </div>
                                    <label for="min_length" class="form-label mt-3"><strong>Minimum Video Length</strong></label>
                                    <p class="form-text text-body-secondary">Only transcode videos longer than this duration in minutes.</p>
                                    <input type="number" class="form-control" id="min_length" name="min_length" value="{{ settings.get('min_length', {}).get('setting_value', 0.5) }}" step="0.1">
                                    <label class="form-label mt-3"><strong>Hardware Acceleration</strong></label>
                                    <p class="form-text text-body-secondary">Force a specific hardware encoder. 'Auto' lets the worker decide.</p>
                                    {% set accel = settings.get('hardware_acceleration', {}).get('setting_value', 'auto') %}
                                    <div class="form-check"><input class="form-check-input" type="radio" name="hardware_acceleration" id="accel_auto" value="auto" {{ 'checked' if accel == 'auto' }}><label class="form-check-label" for="accel_auto">Auto</label></div>
                                    <div class="form-check"><input class="form-check-input" type="radio" name="hardware_acceleration" id="accel_nvidia" value="nvidia" {{ 'checked' if accel == 'nvidia' }}><label class="form-check-label" for="accel_nvidia">NVIDIA NVENC</label></div>
                                    <div class="form-check"><input class="form-check-input" type="radio" name="hardware_acceleration" id="accel_qsv" value="qsv" {{ 'checked' if accel == 'qsv' }}><label class="form-check-label" for="accel_qsv">Intel QSV</label></div>
                                    <div class="form-check"><input class="form-check-input" type="radio" name="hardware_acceleration" id="accel_vaapi" value="vaapi" {{ 'checked' if accel == 'vaapi' }}><label class="form-check-label" for="accel_vaapi">VA-API</label></div>
                                    <div class="form-check"><input class="form-check-input" type="radio" name="hardware_acceleration" id="accel_cpu" value="cpu" {{ 'checked' if accel == 'cpu' }}><label class="form-check-label" for="accel_cpu">CPU Only</label></div>
                                    <label class="form-label mt-3"><strong>Codecs Eligible for Re-Encoding</strong></label>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" id="allow_hevc" name="allow_hevc" value="true" {{ 'checked' if settings.get('allow_hevc', {}).get('setting_value') == 'true' }}>
                                        <label class="form-check-label" for="allow_hevc">HEVC (H.265)</label>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" id="allow_av1" name="allow_av1" value="true" {{ 'checked' if settings.get('allow_av1', {}).get('setting_value') == 'true' }}>
                                        <label class="form-check-label" for="allow_av1">AV1</label>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" id="allow_vp9" name="allow_vp9" value="true" {{ 'checked' if settings.get('allow_vp9', {}).get('setting_value') == 'true' }}>
                                        <label class="form-check-label" for="allow_vp9">VP9</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr class="my-4">
                        <div id="advanced-transcoding-section" class="d-none">
                            <h5>Advanced Transcoding Settings</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3 p-3 border rounded">
                                        <label class="form-label"><strong>Constant Quality (CQ / CRF)</strong></label>
                                        <p class="form-text text-body-secondary">Lower is higher quality. NVENC: 0-51. VAAPI/CPU: 0-63.</p>
                                        <div class="input-group input-group-sm mb-2">
                                            <span class="input-group-text" style="width: 120px;">NVIDIA (HD)</span>
                                            <input type="number" class="form-control" name="nvenc_cq_hd" value="{{ settings.get('nvenc_cq_hd', {}).get('setting_value', 32) }}">
                                            <span class="input-group-text" style="width: 120px;">NVIDIA (SD)</span>
                                            <input type="number" class="form-control" name="nvenc_cq_sd" value="{{ settings.get('nvenc_cq_sd', {}).get('setting_value', 28) }}">
                                        </div>
                                        <div class="input-group input-group-sm mb-2">
                                            <span class="input-group-text" style="width: 120px;">Intel/AMD (HD)</span>
                                            <input type="number" class="form-control" name="vaapi_cq_hd" value="{{ settings.get('vaapi_cq_hd', {}).get('setting_value', 28) }}">
                                            <span class="input-group-text" style="width: 120px;">Intel/AMD (SD)</span>
                                            <input type="number" class="form-control" name="vaapi_cq_sd" value="{{ settings.get('vaapi_cq_sd', {}).get('setting_value', 24) }}">
                                        </div>
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text" style="width: 120px;">CPU (HD)</span>
                                            <input type="number" class="form-control" name="cpu_cq_hd" value="{{ settings.get('cpu_cq_hd', {}).get('setting_value', 28) }}">
                                            <span class="input-group-text" style="width: 120px;">CPU (SD)</span>
                                            <input type="number" class="form-control" name="cpu_cq_sd" value="{{ settings.get('cpu_cq_sd', {}).get('setting_value', 24) }}">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3 p-3 border rounded">
                                        <label for="cq_width_threshold" class="form-label"><strong>HD Width Threshold</strong></label>
                                        <p class="form-text text-body-secondary">Videos wider than this (in pixels) use the "HD" quality setting.</p>
                                        <input type="number" class="form-control" id="cq_width_threshold" name="cq_width_threshold" value="{{ settings.get('cq_width_threshold', {}).get('setting_value', 1900) }}">                                    
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-outline-primary"><span class="mdi mdi-content-save"></span> Save Settings</button>
                    </form>
                </div>
            </div>
            <!-- Tools Tab -->
            <div class="tab-pane fade" id="tools-tab-pane" role="tabpanel">
                <div class="mt-3">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Tools</h1>
                    </div>

                    <!-- Sonarr Tools Section -->
                    <div class="p-3 border rounded mb-4">
                        {% if settings.get('sonarr_enabled', {}).get('setting_value') == 'true' %}
                            <h5>Sonarr</h5>
                            <!-- Sonarr Stats Cards -->
                            <div class="row text-center g-3 mb-3" id="sonarr-stats-container">
                                <div class="col-md-4"><div class="card bg-body-secondary"><div class="card-body py-2">
                                    <h5 class="card-title mb-0" id="sonarr-stat-shows">-</h5><p class="card-text text-muted small mb-0">TV Shows</p>
                                </div></div></div>
                                <div class="col-md-4"><div class="card bg-body-secondary"><div class="card-body py-2">
                                    <h5 class="card-title mb-0" id="sonarr-stat-seasons">-</h5><p class="card-text text-muted small mb-0">Seasons</p>
                                </div></div></div>
                                <div class="col-md-4"><div class="card bg-body-secondary"><div class="card-body py-2">
                                    <h5 class="card-title mb-0" id="sonarr-stat-episodes">-</h5><p class="card-text text-muted small mb-0">Episodes</p>
                                </div></div></div>
                            </div>
                            <p class="form-text text-body-secondary">Run manual scans against your Sonarr instance.</p>
                            <div class="btn-group mb-3" role="group">
                                <button id="sonarr-rename-scan-button" class="btn btn-outline-primary"><span class="mdi mdi-pen"></span> Scan for Renames</button>
                                <button id="sonarr-quality-scan-button" class="btn btn-outline-info"><span class="mdi mdi-television-classic"></span> Scan for Quality</button>
                                <button id="sonarr-cancel-scan-button" class="btn btn-outline-danger" style="display: none;"><span class="mdi mdi-cancel"></span> Cancel Scan</button>
                            </div>

                            <!-- Feedback & Progress for Rename Scan -->
                            <div id="sonarr-rename-scan-container" class="alert alert-success mt-3 progress-box" style="display: none;">
                                <div id="sonarr-rename-scan-feedback" class="mb-2"></div>
                                <div id="sonarr-rename-scan-progress">
                                    <p id="sonarr-rename-scan-progress-text" class="mb-1">Scanning for renames...</p>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-teal" role="progressbar" style="width: 0%;">0%</div>
                                    </div>
                                    <small id="sonarr-rename-scan-time" class="text-muted"></small>
                                </div>
                            </div>

                            <!-- Feedback & Progress for Quality Scan -->
                            <div id="sonarr-quality-scan-container" class="alert alert-info mt-3 progress-box" style="display: none;">
                                <div id="sonarr-quality-scan-feedback" class="mb-2"></div>
                                <div id="sonarr-quality-scan-progress">
                                    <p id="sonarr-quality-scan-progress-text" class="mb-1">Scanning for quality mismatches...</p>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-teal" role="progressbar" style="width: 0%;">0%</div>
                                    </div>
                                    <small id="sonarr-quality-scan-time" class="text-muted"></small>
                                </div>
                            </div>

                        {% else %}
                            <h5>Sonarr <span class="badge badge-outline-secondary">Disabled</span></h5>
                            <p class="form-text text-body-secondary">
                                To use these tools, please 
                                <a href="#" id="enable-sonarr-link">enable the Sonarr integration in the Options tab</a>.
                            </p>
                        {% endif %}
                    </div>

                    <!-- Radarr Tools Section -->
                    <div class="p-3 border rounded mb-4">
                        {% if settings.get('radarr_enabled', {}).get('setting_value') == 'true' %}
                            <h5>Radarr</h5>
                            <!-- Radarr Stats Cards -->
                            <div class="row text-center g-3 mb-3" id="radarr-stats-container">
                                <div class="col-md-4"><div class="card bg-body-secondary"><div class="card-body py-2">
                                    <h5 class="card-title mb-0" id="radarr-stat-movies">-</h5><p class="card-text text-muted small mb-0">Total Movies</p>
                                </div></div></div>
                            </div>
                            <p class="form-text text-body-secondary">Run manual scans against your Radarr instance.</p>
                            <div class="btn-group mb-3" role="group">
                                <button id="radarr-rename-scan-button" class="btn btn-outline-primary"><span class="mdi mdi-pen"></span> Scan for Renames</button>
                                <button id="radarr-cancel-scan-button" class="btn btn-outline-danger" style="display: none;"><span class="mdi mdi-cancel"></span> Cancel Scan</button>
                            </div>

                            <!-- Feedback & Progress for Radarr Rename Scan -->
                            <div id="radarr-rename-scan-container" class="alert alert-success mt-3 progress-box" style="display: none;">
                                <div id="radarr-rename-scan-feedback" class="mb-2"></div>
                                <div id="radarr-rename-scan-progress">
                                    <p id="radarr-rename-scan-progress-text" class="mb-1">Scanning for renames...</p>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-teal" role="progressbar" style="width: 0%;">0%</div>
                                    </div>
                                    <small id="radarr-rename-scan-time" class="text-muted"></small>
                                </div>
                            </div>

                        {% else %}
                            <h5>Radarr <span class="badge badge-outline-secondary">Disabled</span></h5>
                            <p class="form-text text-body-secondary">
                                To use these tools, please 
                                <a href="#" id="enable-radarr-link">enable the Radarr integration in the Options tab</a>.
                            </p>
                        {% endif %}
                    </div>

                    <!-- Lidarr Tools Section -->
                    <div class="p-3 border rounded mb-4">
                        {% if settings.get('lidarr_enabled', {}).get('setting_value') == 'true' %}
                            <h5>Lidarr</h5>
                            <!-- Lidarr Stats Cards -->
                            <div class="row text-center g-3 mb-3" id="lidarr-stats-container">
                                <div class="col-md-4"><div class="card bg-body-secondary"><div class="card-body py-2">
                                    <h5 class="card-title mb-0" id="lidarr-stat-artists">-</h5><p class="card-text text-muted small mb-0">Artists</p>
                                </div></div></div>
                                <div class="col-md-4"><div class="card bg-body-secondary"><div class="card-body py-2">
                                    <h5 class="card-title mb-0" id="lidarr-stat-albums">-</h5><p class="card-text text-muted small mb-0">Albums</p>
                                </div></div></div>
                                <div class="col-md-4"><div class="card bg-body-secondary"><div class="card-body py-2">
                                    <h5 class="card-title mb-0" id="lidarr-stat-tracks">-</h5><p class="card-text text-muted small mb-0">Tracks</p>
                                </div></div></div>
                            </div>
                            <p class="form-text text-body-secondary">Run manual scans against your Lidarr instance.</p>
                            <div class="btn-group mb-3" role="group">
                                <button id="lidarr-rename-scan-button" class="btn btn-outline-primary"><span class="mdi mdi-pen"></span> Scan for Renames</button>
                                <button id="lidarr-cancel-scan-button" class="btn btn-outline-danger" style="display: none;"><span class="mdi mdi-cancel"></span> Cancel Scan</button>
                            </div>

                            <!-- Feedback & Progress for Lidarr Rename Scan -->
                            <div id="lidarr-rename-scan-container" class="alert alert-success mt-3 progress-box" style="display: none;">
                                <div id="lidarr-rename-scan-feedback" class="mb-2"></div>
                                <div id="lidarr-rename-scan-progress">
                                    <p id="lidarr-rename-scan-progress-text" class="mb-1">Scanning for renames...</p>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-teal" role="progressbar" style="width: 0%;">0%</div>
                                    </div>
                                    <small id="lidarr-rename-scan-time" class="text-muted"></small>
                                </div>
                            </div>

                        {% else %}
                            <h5>Lidarr <span class="badge badge-outline-secondary">Disabled</span></h5>
                            <p class="form-text text-body-secondary">
                                To use these tools, please 
                                <a href="#" id="enable-lidarr-link">enable the Lidarr integration in the Options tab</a>.
                            </p>
                        {% endif %}
                    </div>

                    <!-- System Cleanup Section -->
                    <div class="p-3 border rounded mb-4">
                        <h5>System Cleanup</h5>
                        <p class="form-text text-body-secondary">This tool creates jobs for workers to clean up stale files left behind by crashed or improperly stopped workers. This includes temporary encode files (<code>.tmp_*</code>) and file locks (<code>.lock</code>).</p>
                        <button class="btn btn-outline-warning" id="create-cleanup-jobs-btn"><span class="mdi mdi-broom"></span> Queue Stale File Cleanup</button>
                        <div id="cleanup-status" class="mt-3"></div>
                    </div>

                    <!-- Data Export Section -->
                    <div class="p-3 border rounded mb-4">
                        <h5>Data Export</h5>
                        <p class="form-text text-body-secondary">Export all your settings, pending jobs, encoding history, and media source configurations to a JSON file for backup purposes. This can be used to restore your configuration on a new installation in the future.</p>
                        <a href="/api/export" class="btn btn-outline-secondary" id="export-data-btn"><span class="mdi mdi-download"></span> Export Data</a>
                    </div>
                </div>
            </div>
        </div>
{% endblock %}

{% block scripts %}
    <!-- Modals -->
    {% include 'modals/failures_modal.html' %}
    {% include 'modals/node_options_modal.html' %}
    {% include 'modals/plex_login_modal.html' %}
    {% include 'modals/jellyfin_login_modal.html' %}
    {% include 'modals/changelog_modal.html' %}
    {% include 'modals/backup_modal.html' %}

    <!-- Pass server-side data to JavaScript -->
    <script>
        window.Librarrarian = {
            settings: {
                use24HourClock: {{ (settings.get('clock_24hr', {}).get('setting_value', 'true') == 'true') | tojson }},
                plexToken: "{{ settings.get('plex_token', {}).get('setting_value', '') }}",
                plexUrl: "{{ settings.get('plex_url', {}).get('setting_value', '') }}",
                plexLibraries: "{{ settings.get('plex_libraries', {}).get('setting_value', '') }}".split(',').filter(Boolean),
                jellyfinApiKey: "{{ settings.get('jellyfin_api_key', {}).get('setting_value', '') }}",
                jellyfinHost: "{{ settings.get('jellyfin_host', {}).get('setting_value', '') }}",
                jellyfinLibraries: "{{ settings.get('jellyfin_libraries', {}).get('setting_value', '') }}".split(',').filter(Boolean),
                internalScanPaths: "{{ settings.get('internal_scan_paths', {}).get('setting_value', '') }}".split(',').filter(Boolean)
            },
            version: "{{ version }}"
        };
    </script>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>

    <!-- Main Application Script -->
    <script src="{{ url_for('static', filename='js/app.js') }}" defer></script>
{% endblock %}