{% extends "base.html" %}

{% block head %}
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        .progress {
            height: 25px;
            font-size: 0.9rem;
        }
    </style>
{% endblock %}

{% block page_title %}
    <div class="d-flex justify-content-between align-items-start mb-2">
        <h1 class="mb-0">Transcode Cluster</h1>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-secondary" id="view-errors-btn" data-bs-toggle="modal" data-bs-target="#failuresModal">
                View Errors <span class="badge" id="fail-count-badge"></span>
            </button>
            <button type="button" class="btn btn-outline-danger" id="clear-errors-btn" title="Clear All Errors">
                &times;
            </button>
        </div>
    </div>
    <!-- The clock is now below the buttons -->
    <div id="clock-container" class="text-end" style="min-height: 1.5rem;"></div>
{% endblock %}

{% block content %}
        <ul class="nav nav-tabs mt-2" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="nodes-tab" data-bs-toggle="tab" data-bs-target="#nodes-tab-pane" type="button" role="tab">Active Nodes</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats-tab-pane" type="button" role="tab">Stats</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="cleanup-tab" data-bs-toggle="tab" data-bs-target="#cleanup-tab-pane" type="button" role="tab">Cleanup</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history-tab-pane" type="button" role="tab">History</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="options-tab" data-bs-toggle="tab" data-bs-target="#options-tab-pane" type="button" role="tab">Options</button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <!-- Nodes Tab -->
            <div class="tab-pane fade show active" id="nodes-tab-pane" role="tabpanel">
                <div id="db-error-alert" class="alert alert-danger mt-3 {{ 'd-none' if not db_error }}">
                    <strong>Database Error:</strong> {{ db_error }}
                </div>
                <div id="nodes-container" class="mt-3">
                    {% if nodes %}
                        {% for node in nodes %}
                        <div class="card mb-3">
                            <div class="card-header fs-5 d-flex justify-content-between align-items-center">
                                <span>{{ node.hostname }}</span>
                                <span class="badge bg-info">{{ node.version }}</span>
                            </div>
                            <div class="card-body">
                                {% if node.percent > 0 %}
                                    <p class="card-text text-body-secondary mb-2" style="font-family: monospace;">{{ node.file }}</p>
                                    <div class="progress" role="progressbar">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated text-bg-{{ node.color }}" style="width: {{ node.percent }}%">
                                            <b>{{ node.percent }}%</b>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="text-center p-3">
                                        <h5 class="card-title text-muted">{{ node.file }}</h5>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="card-footer text-end bg-transparent">
                                {% if node.percent > 0 %}
                                    <span class="badge text-bg-secondary me-2">FPS: {{ node.fps }}</span>
                                    <span class="badge text-bg-secondary me-2">Speed: {{ node.speed }}x</span>
                                    <span class="badge text-bg-{{ node.color }}">Codec: {{ node.codec }}</span>
                                {% else %}
                                    <span class="badge text-bg-secondary">Idle</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center p-5">
                            <p class="text-muted">No active nodes found.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            <!-- Stats Tab -->
            <div class="tab-pane fade" id="stats-tab-pane" role="tabpanel">
                <div class="mt-3">
                    <div class="row text-center g-3" id="stats-cards-container">
                        <!-- Stat cards will be loaded here by JavaScript -->
                        <div class="col-12">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                    <hr class="my-4">
                    <h5>Recently Encoded Files</h5>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>File</th>
                                    <th>Node</th>
                                    <th>Codec</th>
                                    <th>Size (GB)</th>
                                    <th>Reduction</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="stats-history-table-body">
                                <tr>
                                    <td colspan="6" class="text-center">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- History Tab -->
            <div class="tab-pane fade" id="history-tab-pane" role="tabpanel">
                <div class="mt-3">
                    <div class="d-flex justify-content-end mb-3">
                        <button class="btn btn-danger" id="clear-history-btn">Clear All History</button>
                    </div>
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>File</th>
                                <th>Node</th>
                                <th>Codec</th>
                                <th>Size (GB)</th>
                                <th>Reduction</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body"></tbody>
                    </table>
                </div>
            </div>
            <!-- Options Tab -->
            <div class="tab-pane fade" id="options-tab-pane" role="tabpanel">
                <div class="mt-3">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ category }} alert-dismissible fade show mt-3" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <form method="POST" action="/options" class="mt-4">
                        <!-- Rescan Delay Setting -->
                        <div class="row">
                            <!-- Left Column -->
                            <div class="col-md-6">
                                <h5>Scanning &amp; File Handling</h5>
                                <div class="mb-3 p-3 border rounded">
                                    <label for="rescan_delay_minutes" class="form-label"><strong>Rescan Delay</strong></label>
                                    <p class="form-text text-body-secondary">Delay in minutes before a worker scans for new files after completing a batch. 0 is immediate.</p>
                                    <div class="d-flex align-items-center">
                                        <input type="range" class="form-range" min="0" max="60" step="1" id="rescan_delay_minutes" name="rescan_delay_minutes" value="{{ settings.get('rescan_delay_minutes', {}).get('value', 0) | int }}">
                                        <span id="delay-value" class="badge bg-primary ms-3" style="width: 60px;">{{ settings.get('rescan_delay_minutes', {}).get('value', 0) | int }} min</span>
                                    </div>
                                </div>
                                <div class="mb-3 p-3 border rounded">
                                    <label for="min_length" class="form-label"><strong>Minimum Video Length</strong></label>
                                    <p class="form-text text-body-secondary">Only transcode videos longer than this duration in minutes.</p>
                                    <input type="number" class="form-control" id="min_length" name="min_length" value="{{ settings.get('min_length', {}).get('value', 0.5) }}" step="0.1">
                                </div>
                                <div class="mb-3 p-3 border rounded">
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" type="checkbox" role="switch" id="recursive_scan" name="recursive_scan" value="true" {{ 'checked' if settings.get('recursive_scan', {}).get('value') == 'true' }}>
                                        <label class="form-check-label" for="recursive_scan"><strong>Recursive Scan</strong></label>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" id="skip_encoded_folder" name="skip_encoded_folder" value="true" {{ 'checked' if settings.get('skip_encoded_folder', {}).get('value') == 'true' }}>
                                        <label class="form-check-label" for="skip_encoded_folder"><strong>Skip 'encoded' Folders</strong></label>
                                    </div>
                                </div>
                                <div class="mb-3 p-3 border rounded">
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" type="checkbox" role="switch" id="keep_original" name="keep_original" value="true" {{ 'checked' if settings.get('keep_original', {}).get('value') == 'true' }}>
                                        <label class="form-check-label" for="keep_original"><strong>Keep Original File</strong></label>
                                    </div>
                                    <label for="backup_directory" class="form-label"><strong>Backup Directory</strong></label>
                                    <p class="form-text text-body-secondary">If specified, move original files here instead of deleting them. Requires "Keep Original" to be off.</p>
                                    <input type="text" class="form-control" id="backup_directory" name="backup_directory" value="{{ settings.get('backup_directory', {}).get('value', '') }}" placeholder="/path/to/backups">
                                </div>
                            </div>
                            <!-- Right Column -->
                            <div class="col-md-6">
                                <h5>Transcoding &amp; System</h5>
                                <div class="mb-3 p-3 border rounded">
                                    <label class="form-label"><strong>Hardware Acceleration</strong></label>
                                    <p class="form-text text-body-secondary">Force a specific hardware encoder. 'Auto' lets the worker decide.</p>
                                    {% set accel = settings.get('hardware_acceleration', {}).get('value', 'auto') %}
                                    <div class="form-check"><input class="form-check-input" type="radio" name="hardware_acceleration" id="accel_auto" value="auto" {{ 'checked' if accel == 'auto' }}><label class="form-check-label" for="accel_auto">Auto</label></div>
                                    <div class="form-check"><input class="form-check-input" type="radio" name="hardware_acceleration" id="accel_nvidia" value="nvidia" {{ 'checked' if accel == 'nvidia' }}><label class="form-check-label" for="accel_nvidia">NVIDIA NVENC</label></div>
                                    <div class="form-check"><input class="form-check-input" type="radio" name="hardware_acceleration" id="accel_qsv" value="qsv" {{ 'checked' if accel == 'qsv' }}><label class="form-check-label" for="accel_qsv">Intel QSV</label></div>
                                    <div class="form-check"><input class="form-check-input" type="radio" name="hardware_acceleration" id="accel_vaapi" value="vaapi" {{ 'checked' if accel == 'vaapi' }}><label class="form-check-label" for="accel_vaapi">VA-API</label></div>
                                    <div class="form-check"><input class="form-check-input" type="radio" name="hardware_acceleration" id="accel_cpu" value="cpu" {{ 'checked' if accel == 'cpu' }}><label class="form-check-label" for="accel_cpu">CPU Only</label></div>
                                </div>
                                <div class="mb-3 p-3 border rounded">
                                    <label class="form-label"><strong>Allowed Codecs</strong></label>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" id="allow_hevc" name="allow_hevc" value="true" {{ 'checked' if settings.get('allow_hevc', {}).get('value') == 'true' }}>
                                        <label class="form-check-label" for="allow_hevc">Allow HEVC (H.265)</label>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" id="allow_av1" name="allow_av1" value="true" {{ 'checked' if settings.get('allow_av1', {}).get('value') == 'true' }}>
                                        <label class="form-check-label" for="allow_av1">Allow AV1</label>
                                    </div>
                                </div>
                                <div class="mb-3 p-3 border rounded">
                                    <label class="form-label"><strong>Maintenance</strong></label>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" id="auto_update" name="auto_update" value="true" {{ 'checked' if settings.get('auto_update', {}).get('value') == 'true' }}>
                                        <label class="form-check-label" for="auto_update">Enable Worker Auto-Update</label>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" id="clean_failures" name="clean_failures" value="true" {{ 'checked' if settings.get('clean_failures', {}).get('value') == 'true' }}>
                                        <label class="form-check-label" for="clean_failures">Clean Failed Jobs on Start</label>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" id="debug" name="debug" value="true" {{ 'checked' if settings.get('debug', {}).get('value') == 'true' }}>
                                        <label class="form-check-label" for="debug">Enable Debug Logging</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr class="my-4">
                        <h5>Advanced Transcoding Settings</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3 p-3 border rounded">
                                    <label class="form-label"><strong>Constant Quality (CQ / CRF)</strong></label>
                                    <p class="form-text text-body-secondary">Lower is higher quality. NVENC: 0-51. VAAPI/CPU: 0-63.</p>
                                    <div class="input-group input-group-sm mb-2">
                                        <span class="input-group-text" style="width: 120px;">NVIDIA (HD)</span>
                                        <input type="number" class="form-control" name="nvenc_cq_hd" value="{{ settings.get('nvenc_cq_hd', {}).get('value', 32) }}">
                                        <span class="input-group-text" style="width: 120px;">NVIDIA (SD)</span>
                                        <input type="number" class="form-control" name="nvenc_cq_sd" value="{{ settings.get('nvenc_cq_sd', {}).get('value', 28) }}">
                                    </div>
                                    <div class="input-group input-group-sm mb-2">
                                        <span class="input-group-text" style="width: 120px;">Intel/AMD (HD)</span>
                                        <input type="number" class="form-control" name="vaapi_cq_hd" value="{{ settings.get('vaapi_cq_hd', {}).get('value', 28) }}">
                                        <span class="input-group-text" style="width: 120px;">Intel/AMD (SD)</span>
                                        <input type="number" class="form-control" name="vaapi_cq_sd" value="{{ settings.get('vaapi_cq_sd', {}).get('value', 24) }}">
                                    </div>
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text" style="width: 120px;">CPU (HD)</span>
                                        <input type="number" class="form-control" name="cpu_cq_hd" value="{{ settings.get('cpu_cq_hd', {}).get('value', 28) }}">
                                        <span class="input-group-text" style="width: 120px;">CPU (SD)</span>
                                        <input type="number" class="form-control" name="cpu_cq_sd" value="{{ settings.get('cpu_cq_sd', {}).get('value', 24) }}">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3 p-3 border rounded">
                                    <label for="cq_width_threshold" class="form-label"><strong>HD Width Threshold</strong></label>
                                    <p class="form-text text-body-secondary">Videos wider than this (in pixels) use the "HD" quality setting.</p>
                                    <input type="number" class="form-control" id="cq_width_threshold" name="cq_width_threshold" value="{{ settings.get('cq_width_threshold', {}).get('value', 1900) }}">
                                    <label for="extensions" class="form-label mt-3"><strong>Allowed Extensions</strong></label>
                                    <input type="text" class="form-control" id="extensions" name="extensions" value="{{ settings.get('extensions', {}).get('value', '.mkv,.mp4') }}">
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Settings</button>
                    </form>
                </div>
            </div>
            <!-- Cleanup Tab -->
            <div class="tab-pane fade" id="cleanup-tab-pane" role="tabpanel">
                <div class="mt-3">
                    <h4>Stale File Cleanup</h4>
                    <p class="text-body-secondary">Find and delete temporary (`.tmp_`) and lock (`.lock`) files left behind by crashed or improperly stopped workers. Files are considered stale if they haven't been modified in the last 30 minutes.</p>
                    <button class="btn btn-primary" id="scan-stale-btn">Scan for Stale Files</button>
                    <hr>
                    <div id="stale-files-results" class="d-none">
                        <h5>Found Stale Files</h5>
                        <div id="stale-files-list" class="mb-3" style="max-height: 400px; overflow-y: auto;">
                            <!-- Stale files will be listed here -->
                        </div>
                        <button class="btn btn-danger" id="delete-stale-btn" disabled>Delete Selected Files</button>
                    </div>
                </div>
            </div>
        </div>
{% endblock %}

{% block scripts %}
    <!-- Failures Modal -->
    <div class="modal fade" id="failuresModal" tabindex="-1" aria-labelledby="failuresModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="failuresModalLabel">Failed Transcodes</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>File</th>
                                <th>Reason</th>
                                <th>Reported At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="failures-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Per-Node Options Modal -->
    <div class="modal fade" id="nodeOptionsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="nodeOptionsModalTitle">Node Options</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>More per-node options will be available here in the future.</p>
                    <button id="quit-node-btn" class="btn btn-danger w-100">Quit Worker Process</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Function to create an HTML element for a single node
        function createNodeCard(node) {
            const isIdle = node.status === 'idle' || node.percent === 0;
            return `
            <div class="card mb-3">
                <div class="card-header fs-5 d-flex justify-content-between align-items-center">
                    <span>${node.hostname}</span>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-2" onclick="showNodeOptions('${node.hostname}')">Options</button>
                        <button class="btn btn-sm btn-success" onclick="startNode('${node.hostname}')" ${node.status === 'running' || node.status === 'paused' ? 'disabled' : ''}>Start</button>
                        <button class="btn btn-sm btn-danger" onclick="stopNode('${node.hostname}')" ${node.status === 'idle' || node.status === 'finishing' ? 'disabled' : ''}>Stop</button>
                        <button class="btn btn-sm btn-warning" onclick="pauseResumeNode('${node.hostname}', '${node.status}')" ${node.status === 'idle' ? 'disabled' : ''}>${node.status === 'paused' ? 'Resume' : 'Pause'}</button>
                        <span class="badge bg-info">${node.version || 'N/A'}</span>
                    </div>
                </div>
                <div class="card-body">
                    ${node.percent > 0 ? `
                        <p class="card-text text-body-secondary mb-2" style="font-family: monospace;">${node.file || 'N/A'}</p>
                        <div class="progress" role="progressbar">
                            <div class="progress-bar progress-bar-striped progress-bar-animated text-bg-${node.color}" style="width: ${node.percent}%">
                                <b>${node.percent}%</b>
                            </div>
                        </div>
                    ` : `
                        <div class="text-center p-3">
                            <h5 class="card-title text-muted">${node.status === 'paused' ? 'Paused' : (node.status === 'finishing' ? 'Finishing...' : node.file)}</h5>
                        </div>
                    `}
                </div>
                <div class="card-footer text-end bg-transparent">
                    ${node.percent > 0 ? `
                        <span class="badge text-bg-secondary me-2">FPS: ${node.fps || 'N/A'}</span>
                        <span class="badge text-bg-secondary me-2">Speed: ${node.speed}x</span>
                        <span class="badge text-bg-${node.color}">Codec: ${node.codec}</span>
                    ` : `
                        <span class="badge text-bg-secondary">${node.status === 'paused' ? 'Paused' : (node.file || 'Idle')}</span>
                    `}
                </div>
            </div>`;
        }

        // Main function to fetch data and update the DOM
        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                // Update summary badges
                const failCount = data.fail_count;
                const failCountBadge = document.getElementById('fail-count-badge');
                const viewErrorsBtn = document.getElementById('view-errors-btn');
                failCountBadge.innerText = failCount;
                failCountBadge.classList.remove('text-bg-light', 'text-bg-dark'); // Reset badge color

                // Update clock
                const clockContainer = document.getElementById('clock-container');
                if (clockContainer) {
                    clockContainer.innerHTML = `<span class="badge text-bg-secondary fs-6">Updated: ${new Date().toLocaleTimeString()}</span>`;
                }

                // Update View Errors button color
                // The badge color is also updated for better contrast
                viewErrorsBtn.classList.remove('btn-danger', 'btn-success');
                const clearErrorsBtn = document.getElementById('clear-errors-btn');
                clearErrorsBtn.style.display = (failCount > 0) ? 'inline-block' : 'none';
                if (failCount > 0) {
                    viewErrorsBtn.classList.add('btn-danger');
                    failCountBadge.classList.add('text-bg-light');
                } else {
                    viewErrorsBtn.classList.add('btn-success');
                    failCountBadge.classList.add('text-bg-light');
                }

                // Update DB error alert
                const errorAlert = document.getElementById('db-error-alert');
                if (data.db_error) {
                    errorAlert.innerHTML = `<strong>Database Error:</strong> ${data.db_error}`;
                    errorAlert.classList.remove('d-none');
                } else {
                    errorAlert.classList.add('d-none');
                }

                // Update nodes list
                const nodesContainer = document.getElementById('nodes-container');
                if (data.nodes && data.nodes.length > 0) {
                    nodesContainer.innerHTML = data.nodes.map(createNodeCard).join('');
                } else {
                    nodesContainer.innerHTML = `
                    <div class="text-center p-5">
                        <p class="text-muted">No active nodes found.</p>
                    </div>`;
                }

            } catch (error) {
                console.error("Failed to fetch status:", error);
                const errorAlert = document.getElementById('db-error-alert');
                errorAlert.innerHTML = `<strong>Frontend Error:</strong> Could not fetch status from the server.`;
                errorAlert.classList.remove('d-none');
            }
        }

        // Function to fetch and display history
        async function updateHistory() {
            const historyBody = document.getElementById('history-table-body');
            try {
                const response = await fetch('/api/history');
                const data = await response.json();
                if (data.history && data.history.length > 0) {
                    historyBody.innerHTML = data.history.map(item => `
                        <tr>
                            <td style="word-break: break-all;">${item.filename}</td>
                            <td>${item.hostname}</td>
                            <td><span class="badge text-bg-secondary">${item.codec}</span></td>
                            ${item.status === 'encoding' ? `
                                <td colspan="2" class="text-center"><span class="badge text-bg-primary">In Progress</span></td>
                            ` : `
                                <td>${item.original_size_gb} → ${item.new_size_gb}</td>
                                <td><span class="badge text-bg-success">${item.reduction_percent}%</span></td>
                            `}
                            <td>${item.encoded_at}</td>
                        </tr>
                    `).join('');
                } else {
                    historyBody.innerHTML = '<tr><td colspan="6" class="text-center">No encoded files found.</td></tr>';
                }
            } catch (error) {
                console.error("Failed to fetch history:", error);
                historyBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Failed to load history.</td></tr>';
            }
        }

        // Function to fetch and display failures in the modal
        document.getElementById('view-errors-btn').addEventListener('click', async () => {
            const tableBody = document.getElementById('failures-table-body');
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center">Loading...</td></tr>';
            try {
                const response = await fetch('/api/failures');
                const data = await response.json();
                if (data.files && data.files.length > 0) {
                    tableBody.innerHTML = data.files.map((file, index) => `
                        <tr>
                            <td style="word-break: break-all;">${file.filename}</td>
                            <td>${file.reason}</td>
                            <td>${file.reported_at}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-log-${index}">
                                    View Log
                                </button>
                            </td>
                        </tr>
                        <tr class="collapse" id="collapse-log-${index}">
                            <td colspan="4"><pre class="bg-dark text-white-50 p-3 rounded" style="max-height: 300px; overflow-y: auto;">${file.log || 'No log available.'}</pre></td>
                        </tr>
                    `).join('');
                } else {
                    tableBody.innerHTML = '<tr><td colspan="3" class="text-center">No failed files found.</td></tr>';
                }
            } catch (error) {
                tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-danger">Failed to load errors.</td></tr>';
            }
        });

        // Function to clear all failures
        document.getElementById('clear-errors-btn').addEventListener('click', async () => {
            if (!confirm('Are you sure you want to permanently clear all failed file logs? This action cannot be undone.')) {
                return;
            }
            try {
                const response = await fetch('/api/failures/clear', { method: 'POST' });
                if (response.ok) {
                    // Manually close the modal if it's open
                    const modal = bootstrap.Modal.getInstance(document.getElementById('failuresModal'));
                    if (modal) modal.hide();
                    // Refresh the status to update the count
                    updateStatus();
                }
            } catch (error) {
                alert('An error occurred while trying to clear the failures.');
            }
        });

        // Main update loop that runs every 5 seconds
        async function mainUpdateLoop() {
            // Always update the main status (nodes, failures, clock)
            await updateStatus();

            // Check which tab is active and update its content if needed
            if (document.querySelector('#stats-tab.active')) {
                await updateStats();
            } else if (document.querySelector('#history-tab.active')) {
                await updateHistory();
            }
        }

        // Run initial update on page load
        updateStatus();

        // Start the main update loop
        setInterval(mainUpdateLoop, 5000);

        // Update history when the tab is shown
        const historyTab = document.querySelector('#history-tab');
        historyTab.addEventListener('shown.bs.tab', event => {
            updateHistory();
        });

        // Update stats when the tab is shown
        const statsTab = document.querySelector('#stats-tab');
        statsTab.addEventListener('shown.bs.tab', event => {
            updateStats();
        });

        // Function to fetch and display stats
        async function updateStats() {
            const statsCardsContainer = document.getElementById('stats-cards-container');
            const statsHistoryBody = document.getElementById('stats-history-table-body');
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();

                // Update the summary cards
                statsCardsContainer.innerHTML = `
                    <div class="col-md-3"><div class="card"><div class="card-body">
                        <h5 class="card-title">${data.stats.total_files}</h5><p class="card-text text-muted">Files Encoded</p>
                    </div></div></div>
                    <div class="col-md-3"><div class="card"><div class="card-body">
                        <h5 class="card-title">${data.stats.total_original_size_gb} GB</h5><p class="card-text text-muted">Original Size</p>
                    </div></div></div>
                    <div class="col-md-3"><div class="card"><div class="card-body">
                        <h5 class="card-title">${data.stats.total_new_size_gb} GB</h5><p class="card-text text-muted">New Size</p>
                    </div></div></div>
                    <div class="col-md-3"><div class="card bg-success text-white"><div class="card-body">
                        <h5 class="card-title">${data.stats.total_reduction_percent}%</h5><p class="card-text">Average Reduction</p>
                    </div></div></div>
                `;

                // Update the history table on the stats page
                if (data.history && data.history.length > 0) {
                    statsHistoryBody.innerHTML = data.history.map(item => `
                        <tr>
                            <td style="word-break: break-all;">${item.filename}</td>
                            <td>${item.hostname}</td>
                            <td><span class="badge text-bg-secondary">${item.codec}</span></td>
                            <td>${item.original_size_gb} → ${item.new_size_gb}</td>
                            <td><span class="badge text-bg-success">${item.reduction_percent}%</span></td>
                            <td>${item.encoded_at}</td>
                        </tr>
                    `).join('');
                } else {
                    statsHistoryBody.innerHTML = '<tr><td colspan="6" class="text-center">No encoded files found.</td></tr>';
                }

            } catch (error) {
                console.error("Failed to fetch stats:", error);
                statsCardsContainer.innerHTML = '<div class="col-12"><div class="alert alert-danger">Failed to load statistics.</div></div>';
                statsHistoryBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Failed to load history.</td></tr>';
            }
        }

        // Function to clear all history
        document.getElementById('clear-history-btn').addEventListener('click', async () => {
            if (!confirm('Are you sure you want to permanently clear the entire transcode history? This action cannot be undone.')) {
                return;
            }
            try {
                const response = await fetch('/api/history/clear', { method: 'POST' });
                if (response.ok) {
                    // Refresh the history table to show it's empty
                    updateHistory();
                }
            } catch (error) {
                console.error('Error clearing history:', error);
                alert('An error occurred while trying to clear the history.');
            }
        });

        // Add event listener for the cleanup tab
        const cleanupTab = document.querySelector('#cleanup-tab');
        cleanupTab.addEventListener('shown.bs.tab', event => {
            // You could add logic here to auto-scan if desired
        });

        // Cleanup Tab Logic
        const scanStaleBtn = document.getElementById('scan-stale-btn');
        const deleteStaleBtn = document.getElementById('delete-stale-btn');
        const staleFilesResults = document.getElementById('stale-files-results');
        const staleFilesList = document.getElementById('stale-files-list');

        scanStaleBtn.addEventListener('click', async () => {
            scanStaleBtn.disabled = true;
            scanStaleBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Scanning...';
            staleFilesList.innerHTML = '';
            try {
                const response = await fetch('/api/cleanup/scan');
                const data = await response.json();
                staleFilesResults.classList.remove('d-none');
                if (data.stale_files && data.stale_files.length > 0) {
                    staleFilesList.innerHTML = data.stale_files.map(file => `
                        <div class="form-check">
                            <input class="form-check-input stale-file-checkbox" type="checkbox" value="${file.path}" id="stale-${file.path.replace(/[^a-zA-Z0-9]/g, '')}" checked>
                            <label class="form-check-label" for="stale-${file.path.replace(/[^a-zA-Z0-9]/g, '')}">
                                ${file.path} <span class="text-muted">(${file.age})</span>
                            </label>
                        </div>
                    `).join('');
                    deleteStaleBtn.disabled = false;
                } else {
                    staleFilesList.innerHTML = '<p class="text-muted">No stale files found.</p>';
                    deleteStaleBtn.disabled = true;
                }
            } catch (error) {
                staleFilesList.innerHTML = '<p class="text-danger">Error scanning for files.</p>';
            } finally {
                scanStaleBtn.disabled = false;
                scanStaleBtn.innerHTML = 'Scan for Stale Files';
            }
        });

        deleteStaleBtn.addEventListener('click', async () => {
            const selectedFiles = Array.from(document.querySelectorAll('.stale-file-checkbox:checked')).map(cb => cb.value);
            if (selectedFiles.length === 0) {
                alert('Please select files to delete.');
                return;
            }
            if (!confirm(`Are you sure you want to delete ${selectedFiles.length} selected files? This cannot be undone.`)) {
                return;
            }
            try {
                await fetch('/api/cleanup/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ files: selectedFiles })
                });
                // Rescan after deletion
                scanStaleBtn.click();
            } catch (error) {
                alert('An error occurred while deleting files.');
            }
        });
    </script>
    <script>
        // Function to send the 'start' command to a node
        async function startNode(hostname) {
            try {
                const response = await fetch(`/api/nodes/${hostname}/start`, {
                    method: 'POST',
                });
                const result = await response.json();

                if (result.success) {
                    // The command was successful, just refresh the UI.
                    // Immediately refresh the status to show the node has started
                    updateStatus();
                } else {
                    // If the server reported an error, show it.
                    alert(`Failed to send start command to ${hostname}: ${result.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error starting node:', error);
                alert(`An error occurred while trying to start ${hostname}.`);
            }
        }

        // Function to send the 'stop' command to a node
        async function stopNode(hostname) {
            if (!confirm(`Are you sure you want to stop the worker on '${hostname}'? It will finish its current file and then go idle.`)) {
                return;
            }
            try {
                const response = await fetch(`/api/nodes/${hostname}/stop`, {
                    method: 'POST',
                });
                const result = await response.json();
                if (result.success) {
                    updateStatus(); // Refresh UI to show the node going idle
                } else {
                    alert(`Failed to send stop command to ${hostname}: ${result.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error stopping node:', error);
            }
        }

        // Function to send 'pause' or 'resume' command
        async function pauseResumeNode(hostname, currentStatus) {
            const action = currentStatus === 'paused' ? 'resume' : 'pause';
            try {
                const response = await fetch(`/api/nodes/${hostname}/${action}`, {
                    method: 'POST',
                });
                const result = await response.json();
                if (result.success) {
                    updateStatus(); // Refresh UI
                } else {
                    alert(`Failed to ${action} node ${hostname}: ${result.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error(`Error ${action}ing node:`, error);
            }
        }

        // Placeholder for future per-node options
        let nodeOptionsModal = null;
        function showNodeOptions(hostname) {
            if (!nodeOptionsModal) {
                nodeOptionsModal = new bootstrap.Modal(document.getElementById('nodeOptionsModal'));
            }
            document.getElementById('nodeOptionsModalTitle').innerText = `Options for ${hostname}`;
            const quitBtn = document.getElementById('quit-node-btn');
            // Re-assign the onclick event to the button for the specific hostname
            quitBtn.onclick = () => quitNode(hostname);
            nodeOptionsModal.show();
        }
    </script>
    <script>
        // Function to send the 'quit' command to a node
        async function quitNode(hostname) {
            if (!confirm(`Are you sure you want to QUIT the worker on '${hostname}'? This will stop the process immediately. The container will likely restart based on Docker policy.`)) {
                return;
            }
            try {
                const response = await fetch(`/api/nodes/${hostname}/quit`, {
                    method: 'POST',
                });
                const result = await response.json();
                if (result.success) {
                    updateStatus(); // Refresh UI to show the node disappearing
                } else {
                    alert(`Failed to send quit command to ${hostname}: ${result.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error quitting node:', error);
            }
        }
    </script>
    <script>
        const delaySlider = document.getElementById('rescan_delay_minutes');
        const delayValue = document.getElementById('delay-value');
        delaySlider.addEventListener('input', (event) => {
            delayValue.textContent = `${event.target.value} min`;
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
