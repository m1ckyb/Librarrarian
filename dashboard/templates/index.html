{% extends "base.html" %}

{% block head %}
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .progress {
            height: 25px;
            font-size: 0.9rem;
        }
    </style>
{% endblock %}

{% block page_title %}
    <h1>Transcode Cluster</h1>
{% endblock %}

{% block content %}
        <ul class="nav nav-tabs mt-3" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="nodes-tab" data-bs-toggle="tab" data-bs-target="#nodes-tab-pane" type="button" role="tab">Active Nodes</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history-tab-pane" type="button" role="tab">History</button>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" href="/options">Options</a>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <!-- Nodes Tab -->
            <div class="tab-pane fade show active" id="nodes-tab-pane" role="tabpanel">
                <div id="db-error-alert" class="alert alert-danger mt-3 {{ 'd-none' if not db_error }}">
                    <strong>Database Error:</strong> {{ db_error }}
                </div>
                <div id="nodes-container" class="mt-3">
                    {% if nodes %}
                        {% for node in nodes %}
                        <div class="card mb-3">
                            <div class="card-header fs-5 d-flex justify-content-between align-items-center">
                                <span>{{ node.hostname }}</span>
                                <span class="badge bg-info">{{ node.version }}</span>
                            </div>
                            <div class="card-body">
                                <p class="card-text text-body-secondary mb-2" style="font-family: monospace;">{{ node.file }}</p>
                                <div class="progress" role="progressbar">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated text-bg-{{ node.color }}" style="width: {{ node.percent }}%">
                                        <b>{{ node.percent }}%</b>
                                {% if node.percent > 0 %}
                                    <p class="card-text text-body-secondary mb-2" style="font-family: monospace;">{{ node.file }}</p>
                                    <div class="progress" role="progressbar">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated text-bg-{{ node.color }}" style="width: {{ node.percent }}%">
                                            <b>{{ node.percent }}%</b>
                                        </div>
                                    </div>
                                </div>
                                {% else %}
                                    <div class="text-center p-3">
                                        <h5 class="card-title text-muted">{{ node.file }}</h5>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="card-footer text-end bg-transparent">
                                <span class="badge text-bg-secondary me-2">FPS: {{ node.fps }}</span>
                                <span class="badge text-bg-secondary me-2">Speed: {{ node.speed }}x</span>
                                <span class="badge text-bg-{{ node.color }}">Codec: {{ node.codec }}</span>
                                {% if node.percent > 0 %}
                                    <span class="badge text-bg-secondary me-2">FPS: {{ node.fps }}</span>
                                    <span class="badge text-bg-secondary me-2">Speed: {{ node.speed }}x</span>
                                    <span class="badge text-bg-{{ node.color }}">Codec: {{ node.codec }}</span>
                                {% else %}
                                    <span class="badge text-bg-secondary">Idle</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center p-5">
                            <p class="text-muted">No active nodes found.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            <!-- History Tab -->
            <div class="tab-pane fade" id="history-tab-pane" role="tabpanel">
                <div class="mt-3">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>File</th>
                                <th>Node</th>
                                <th>Codec</th>
                                <th>Size (GB)</th>
                                <th>Reduction</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="position-fixed end-0 p-3" style="bottom: 60px;">
            <div class="btn-group" role="group">
                <button type="button" class="btn" id="view-errors-btn" data-bs-toggle="modal" data-bs-target="#failuresModal">
                    View Errors <span class="badge text-bg-light" id="fail-count-badge">{{ fail_count }}</span>
                </button>
                <button type="button" class="btn btn-outline-danger" id="clear-errors-btn" title="Clear All Errors">
                    &times;
                </button>
            </div>
        </div>
{% endblock %}

{% block scripts %}
    <!-- Failures Modal -->
    <div class="modal fade" id="failuresModal" tabindex="-1" aria-labelledby="failuresModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="failuresModalLabel">Failed Transcodes</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>File</th>
                                <th>Reason</th>
                                <th>Reported At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="failures-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Function to create an HTML element for a single node
        function createNodeCard(node) {
            return `
            <div class="card mb-3">
                <div class="card-header fs-5 d-flex justify-content-between align-items-center">
                    <span>${node.hostname}</span>
                    <span class="badge bg-info">${node.version || 'N/A'}</span>
                </div>
                <div class="card-body">
                    <p class="card-text text-body-secondary mb-2" style="font-family: monospace;">${node.file || 'N/A'}</p>
                    <div class="progress" role="progressbar">
                        <div class="progress-bar progress-bar-striped progress-bar-animated text-bg-${node.color}" style="width: ${node.percent}%">
                            <b>${node.percent}%</b>
                    ${node.percent > 0 ? `
                        <p class="card-text text-body-secondary mb-2" style="font-family: monospace;">${node.file || 'N/A'}</p>
                        <div class="progress" role="progressbar">
                            <div class="progress-bar progress-bar-striped progress-bar-animated text-bg-${node.color}" style="width: ${node.percent}%">
                                <b>${node.percent}%</b>
                            </div>
                        </div>
                    </div>
                    ` : `
                        <div class="text-center p-3">
                            <h5 class="card-title text-muted">${node.file}</h5>
                        </div>
                    `}
                </div>
                <div class="card-footer text-end bg-transparent">
                    <span class="badge text-bg-secondary me-2">FPS: ${node.fps || 'N/A'}</span>
                    <span class="badge text-bg-secondary me-2">Speed: ${node.speed}x</span>
                    <span class="badge text-bg-${node.color}">Codec: ${node.codec}</span>
                    ${node.percent > 0 ? `
                        <span class="badge text-bg-secondary me-2">FPS: ${node.fps || 'N/A'}</span>
                        <span class="badge text-bg-secondary me-2">Speed: ${node.speed}x</span>
                        <span class="badge text-bg-${node.color}">Codec: ${node.codec}</span>
                    ` : `
                        <span class="badge text-bg-secondary">Idle</span>
                    `}
                </div>
            </div>`;
        }

        // Main function to fetch data and update the DOM
        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                // Update summary badges
                const failCount = data.fail_count;
                const failCountBadge = document.getElementById('fail-count-badge');
                const viewErrorsBtn = document.getElementById('view-errors-btn');
                const clearErrorsBtn = document.getElementById('clear-errors-btn');
                failCountBadge.innerText = failCount;
                document.getElementById('last-updated').innerText = new Date().toLocaleTimeString();

                // Update View Errors button color
                viewErrorsBtn.classList.remove('btn-danger', 'btn-success');
                clearErrorsBtn.style.display = (failCount > 0) ? 'inline-block' : 'none';
                if (failCount > 0) {
                    viewErrorsBtn.classList.add('btn-danger');
                } else {
                    viewErrorsBtn.classList.add('btn-success');
                }

                // Update DB error alert
                const errorAlert = document.getElementById('db-error-alert');
                if (data.db_error) {
                    errorAlert.innerHTML = `<strong>Database Error:</strong> ${data.db_error}`;
                    errorAlert.classList.remove('d-none');
                } else {
                    errorAlert.classList.add('d-none');
                }

                // Update nodes list
                const nodesContainer = document.getElementById('nodes-container');
                if (data.nodes && data.nodes.length > 0) {
                    nodesContainer.innerHTML = data.nodes.map(createNodeCard).join('');
                } else {
                    nodesContainer.innerHTML = `
                    <div class="text-center p-5">
                        <p class="text-muted">No active nodes found.</p>
                    </div>`;
                }

            } catch (error) {
                console.error("Failed to fetch status:", error);
                const errorAlert = document.getElementById('db-error-alert');
                errorAlert.innerHTML = `<strong>Frontend Error:</strong> Could not fetch status from the server.`;
                errorAlert.classList.remove('d-none');
            }
        }

        // Function to fetch and display history
        async function updateHistory() {
            const historyBody = document.getElementById('history-table-body');
            try {
                const response = await fetch('/api/history');
                const data = await response.json();
                if (data.history && data.history.length > 0) {
                    historyBody.innerHTML = data.history.map(item => `
                        <tr>
                            <td style="word-break: break-all;">${item.filename}</td>
                            <td>${item.hostname}</td>
                            <td><span class="badge text-bg-secondary">${item.codec}</span></td>
                            <td>${item.original_size_gb} â†’ ${item.new_size_gb}</td>
                            <td><span class="badge text-bg-success">${item.reduction_percent}%</span></td>
                            <td>${item.encoded_at}</td>
                        </tr>
                    `).join('');
                } else {
                    historyBody.innerHTML = '<tr><td colspan="6" class="text-center">No encoded files found.</td></tr>';
                }
            } catch (error) {
                console.error("Failed to fetch history:", error);
                historyBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Failed to load history.</td></tr>';
            }
        }

        // Function to fetch and display failures in the modal
        document.getElementById('view-errors-btn').addEventListener('click', async () => {
            const tableBody = document.getElementById('failures-table-body');
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center">Loading...</td></tr>';
            try {
                const response = await fetch('/api/failures');
                const data = await response.json();
                if (data.files && data.files.length > 0) {
                    tableBody.innerHTML = data.files.map((file, index) => `
                        <tr>
                            <td style="word-break: break-all;">${file.filename}</td>
                            <td>${file.reason}</td>
                            <td>${file.reported_at}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-log-${index}">
                                    View Log
                                </button>
                            </td>
                        </tr>
                        <tr class="collapse" id="collapse-log-${index}">
                            <td colspan="4"><pre class="bg-dark text-white-50 p-3 rounded" style="max-height: 300px; overflow-y: auto;">${file.log || 'No log available.'}</pre></td>
                        </tr>
                    `).join('');
                } else {
                    tableBody.innerHTML = '<tr><td colspan="3" class="text-center">No failed files found.</td></tr>';
                }
            } catch (error) {
                tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-danger">Failed to load errors.</td></tr>';
            }
        });

        // Function to clear all failures
        document.getElementById('clear-errors-btn').addEventListener('click', async () => {
            if (!confirm('Are you sure you want to permanently clear all failed file logs? This action cannot be undone.')) {
                return;
            }
            try {
                const response = await fetch('/api/failures/clear', { method: 'POST' });
                if (response.ok) {
                    // Manually close the modal if it's open
                    const modal = bootstrap.Modal.getInstance(document.getElementById('failuresModal'));
                    if (modal) modal.hide();
                    // Refresh the status to update the count
                    updateStatus();
                }
            } catch (error) {
                alert('An error occurred while trying to clear the failures.');
            }
        });

        // Set initial button color on page load
        updateStatus();

        // Run the update function every 5 seconds (5000 milliseconds)
        setInterval(updateStatus, 5000);

        // Update history when the tab is shown
        const historyTab = document.querySelector('#history-tab');
        historyTab.addEventListener('shown.bs.tab', event => {
            updateHistory();
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
